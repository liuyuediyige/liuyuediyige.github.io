<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高三（1）班点名器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #3a5a8c;
            --accent-color: #ff9a00;
            --gradient-start: #6a11cb;
            --gradient-end: #2575fc;
            --card-bg: #ffffff;
            --text-color: #333333;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --chat-primary: #4a6fa5;
            --chat-secondary: #f0f4ff;
            --chat-border: #d1ddff;
            --message-text-color: #333333;
            --message-own-text-color: #ffffff;
            --wechat-green: #07c160;
            --wechat-green-light: #e0f7e9;
        }
        
        body {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            color: var(--text-color);
            min-height: 100vh;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: default;
            font-size: 14px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
            min-height: 700px;
            position: relative;
        }
        
        /* 头部样式 */
        header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 1.8rem;
            color: var(--accent-color);
        }
        
        .logo h1 {
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* 公告栏样式 */
        .announcement-container {
            flex: 1;
            margin: 0 15px;
            overflow: hidden;
            position: relative;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
        }
        
        .announcement-icon {
            color: #FFD700;
            font-size: 1.2rem;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .announcement-content {
            font-size: 1.1rem;
            font-weight: bold;
            white-space: nowrap;
            color: #FFD700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .announcement-scroll {
            display: inline-block;
            animation: marquee 15s linear infinite;
            padding-left: 100%;
        }
        
        .announcement-scroll.paused {
            animation-play-state: paused;
        }
        
        @keyframes marquee {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-100%);
            }
        }
        
        .qq-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid white;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }
        
        .qq-avatar:hover {
            transform: scale(1.08);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
        }
        
        .qq-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 5px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }
        
        .menu-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* 留言板按钮 */
        .chat-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 5px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
            flex-shrink: 0;
        }
        
        .chat-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-notification {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background-color: #ff4757;
            border-radius: 50%;
        }
        
        .chat-notification.hidden {
            display: none;
        }
        
        /* 主要内容区 */
        .main-content {
            display: flex;
            flex: 1;
            padding: 15px;
            gap: 15px;
            height: calc(100% - 60px);
        }
        
        .left-panel {
            flex: 0.7;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-width: 350px;
        }
        
        .right-panel {
            flex: 1.3;
            display: flex;
            flex-direction: column;
            gap: 15px;
            justify-content: center;
        }
        
        .start-btn {
            background: linear-gradient(to right, #ff9a00, #ff5e00);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.4rem;
            font-weight: bold;
            border-radius: 40px;
            cursor: pointer;
            box-shadow: 0 6px 15px rgba(255, 94, 0, 0.3);
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 300px;
        }
        
        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 94, 0, 0.4);
        }
        
        .start-btn:active {
            transform: translateY(-1px);
        }
        
        .start-btn i {
            font-size: 2.2rem;
        }
        
        /* 抽取人数选择器 */
        .number-selector-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 300px;
            margin-bottom: 15px;
        }
        
        .number-selector-container h3 {
            margin-bottom: 12px;
            color: var(--secondary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .number-selector-container h3 i {
            color: var(--primary-color);
        }
        
        .number-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center;
        }
        
        .number-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f4ff;
            border: 2px solid #d1ddff;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .number-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.08);
        }
        
        .number-btn:hover:not(.active) {
            background: #e0e8ff;
            transform: scale(1.05);
        }
        
        .result-container {
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .result-title {
            text-align: center;
            font-size: 1.2rem;
            color: var(--secondary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .result-display {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            justify-items: center;
            overflow-y: auto;
            padding: 5px;
            flex: 1;
            min-height: 0;
        }
        
        .student-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            width: 100%;
            max-width: 160px;
            position: relative;
            transform-style: preserve-3d;
        }
        
        .student-card:hover {
            transform: translateY(-5px) rotateX(3deg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        }
        
        .avatar-container {
            height: 140px;
            background: linear-gradient(135deg, #f5f9ff 0%, #e8f0ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        
        .student-card:hover .avatar {
            transform: scale(1.03);
        }
        
        .default-avatar {
            font-size: 3rem;
            color: #b8c9ff;
        }
        
        .student-info {
            padding: 10px;
            text-align: center;
            background: white;
            position: relative;
        }
        
        .student-name {
            font-weight: 700;
            color: #333;
            font-size: 1rem;
            margin-bottom: 3px;
        }
        
        .student-number {
            color: #6c757d;
            font-size: 0.85rem;
        }
        
        /* 选中特效 */
        .student-card.selected {
            animation: selectEffect 0.8s ease-out;
            box-shadow: 0 0 20px rgba(74, 111, 165, 0.4);
            border: 2px solid var(--primary-color);
        }
        
        .student-card.highlight {
            animation: highlightEffect 1.5s infinite alternate;
        }
        
        /* 结果数字徽章 */
        .result-badge {
            position: absolute;
            top: 140px;
            right: 0px;
            background: linear-gradient(135deg, #ff9a00, #ff5e00);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
            box-shadow: 0 3px 8px rgba(255, 94, 0, 0.3);
            z-index: 10;
        }
        
        /* 侧边菜单 */
        .sidebar {
            position: fixed;
            top: 0;
            left: -380px;
            width: 360px;
            height: 100%;
            background: white;
            box-shadow: 5px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: left 0.4s ease;
            overflow-y: auto;
            padding: 20px;
        }
        
        .sidebar.active {
            left: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .sidebar-header h2 {
            color: var(--secondary-color);
            font-size: 1.3rem;
        }
        
        .close-menu {
            background: none;
            border: none;
            font-size: 1.3rem;
            color: #777;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-menu:hover {
            background: #f5f5f5;
        }
        
        /* 留言板弹窗 */
        .chat-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 900px;
            height: 80vh;
            max-height: 700px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .chat-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .chat-header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .chat-header h3 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .chat-users {
            width: 250px;
            background: #f8f9ff;
            border-right: 1px solid var(--chat-border);
            padding: 15px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .chat-users h4 {
            margin-bottom: 15px;
            color: var(--secondary-color);
            padding-bottom: 10px;
            border-bottom: 1px solid var(--chat-border);
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .user-item:hover {
            background: #e8f0ff;
        }
        
        .user-item.active {
            background: var(--chat-secondary);
            border-left: 3px solid var(--chat-primary);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: #333;
            margin-bottom: 3px;
        }
        
        .user-status {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #f5f5f5;
        }
        
        .message {
            display: flex;
            gap: 12px;
            max-width: 80%;
            animation: messageAppear 0.3s ease;
        }
        
        .message.own {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message-sender-name {
            font-size: 0.7rem;
            margin-top: 3px;
            color: #666;
            text-align: center;
            max-width: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .message-content {
            background: var(--wechat-green-light);
            padding: 12px 15px;
            border-radius: 15px;
            border-top-left-radius: 0;
            position: relative;
            max-width: 100%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .message.own .message-content {
            background: var(--wechat-green);
            color: white;
            border-top-left-radius: 15px;
            border-top-right-radius: 0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .message-sender {
            font-weight: 600;
            font-size: 0.95rem;
            color: #333;
        }
        
        .message.own .message-sender {
            color: white;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .message.own .message-time {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .message-text {
            word-wrap: break-word;
            line-height: 1.5;
            font-weight: 500;
            color: var(--message-text-color);
        }
        
        .message.own .message-text {
            color: var(--message-own-text-color);
        }
        
        .message-image {
            max-width: 250px;
            max-height: 250px;
            border-radius: 10px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .message-image:hover {
            transform: scale(1.02);
        }
        
        .message-actions {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            font-size: 0.8rem;
        }
        
        .message-action {
            color: #6c757d;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .message.own .message-action {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .message-action:hover {
            color: var(--chat-primary);
        }
        
        .message.own .message-action:hover {
            color: white;
        }
        
        .reply-indicator {
            background: #f0f4ff;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid var(--chat-primary);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reply-sender {
            font-weight: 600;
            color: var(--chat-primary);
        }
        
        .cancel-reply {
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .cancel-reply:hover {
            color: #666;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid var(--chat-border);
            background: white;
            flex-shrink: 0;
        }
        
        .reply-preview {
            margin-bottom: 10px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--chat-border);
            border-radius: 25px;
            font-size: 0.95rem;
            resize: none;
            max-height: 120px;
            min-height: 50px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .chat-input:focus {
            border-color: var(--chat-primary);
        }
        
        .chat-actions {
            display: flex;
            gap: 5px;
        }
        
        .chat-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--chat-secondary);
            border: none;
            color: var(--chat-primary);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .chat-action-btn:hover {
            background: var(--chat-primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .send-btn {
            background: linear-gradient(135deg, var(--chat-primary), #6a8cc5);
            color: white;
        }
        
        .send-btn:hover {
            background: linear-gradient(135deg, #3a5a8c, #5a7cb5);
        }
        
        /* 用户设置弹窗 */
        .user-settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            z-index: 3000;
            padding: 25px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .user-settings-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .user-settings-header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .user-settings-header h4 {
            color: var(--secondary-color);
            font-size: 1.4rem;
        }
        
        .avatar-upload-area {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .avatar-preview-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 15px;
            border: 4px solid var(--chat-secondary);
            position: relative;
            cursor: pointer;
        }
        
        .avatar-preview-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-change-btn {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            font-size: 0.85rem;
        }
        
        .avatar-upload-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .avatar-upload-btn {
            padding: 8px 15px;
            background: var(--chat-secondary);
            border: none;
            border-radius: 20px;
            color: var(--chat-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .avatar-upload-btn:hover {
            background: var(--chat-primary);
            color: white;
        }
        
        .user-name-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--chat-border);
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .user-name-input:focus {
            border-color: var(--chat-primary);
        }
        
        .user-settings-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .user-settings-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .settings-cancel-btn {
            background: #f8f9ff;
            color: var(--chat-primary);
        }
        
        .settings-cancel-btn:hover {
            background: #e8f0ff;
        }
        
        .settings-save-btn {
            background: linear-gradient(135deg, var(--chat-primary), #6a8cc5);
            color: white;
        }
        
        .settings-save-btn:hover {
            background: linear-gradient(135deg, #3a5a8c, #5a7cb5);
        }
        
        /* 留言板设置弹窗 */
        .chat-settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            z-index: 3500;
            padding: 25px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .chat-settings-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .chat-settings-header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chat-settings-header h4 {
            color: var(--secondary-color);
            font-size: 1.4rem;
        }
        
        .chat-setting-item {
            margin-bottom: 20px;
        }
        
        .chat-setting-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .chat-setting-item select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        
        .clear-chat-btn {
            width: 100%;
            padding: 12px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }
        
        .clear-chat-btn:hover {
            background: #ff3742;
        }
        
        .chat-settings-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .chat-settings-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        /* 图片预览弹窗 */
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 4000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .image-preview-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .image-preview-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .image-preview-content img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .close-image-preview {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            font-size: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .close-image-preview:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* 抽取设置 - 移到菜单中 */
        .roll-settings-controls {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 3px solid var(--accent-color);
        }
        
        .roll-settings-controls p {
            margin-bottom: 8px;
            line-height: 1.4;
            font-size: 0.9rem;
        }
        
        .roll-settings-controls strong {
            color: var(--primary-color);
        }
        
        .menu-section {
            margin-bottom: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .menu-section-header {
            padding: 12px;
            background: #f8f9ff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
        }
        
        .menu-section-header i {
            transition: transform 0.3s;
            font-size: 0.9rem;
        }
        
        .menu-section-header.active i {
            transform: rotate(180deg);
        }
        
        .menu-section-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .menu-section-content.active {
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .menu-section-content h4 {
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-size: 1rem;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
        }
        
        .menu-section-content p {
            margin-bottom: 8px;
            line-height: 1.5;
            color: #555;
            font-size: 0.9rem;
        }
        
        .menu-section-content ul {
            padding-left: 18px;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }
        
        .menu-section-content li {
            margin-bottom: 4px;
            line-height: 1.5;
            color: #555;
        }
        
        /* 密码验证框 */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            display: none;
        }
        
        .password-dialog {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        
        .password-dialog h3 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .password-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }
        
        .password-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .password-buttons {
            display: flex;
            gap: 12px;
        }
        
        .password-buttons button {
            flex: 1;
            padding: 10px;
            font-size: 0.9rem;
        }
        
        /* 设置控件 */
        .setting-control {
            margin-bottom: 12px;
        }
        
        .setting-control label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }
        
        .setting-control input[type="number"],
        .setting-control input[type="text"],
        .setting-control select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .setting-control input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .btn {
            padding: 10px 15px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--secondary-color);
        }
        
        .btn-secondary {
            background: #f0f4ff;
            color: var(--primary-color);
        }
        
        .btn-secondary:hover {
            background: #e0e8ff;
        }
        
        /* 学生名单视图 */
        .student-list-view {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }
        
        .student-list-item {
            padding: 8px 12px;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .student-list-item:last-child {
            border-bottom: none;
        }
        
        .student-list-item.selected {
            background-color: #e8f0ff;
        }
        
        .student-list-item.excluded {
            background-color: #ffeaea;
            opacity: 0.7;
        }
        
        .student-list-item .student-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .student-list-item .student-number {
            font-weight: bold;
            color: var(--secondary-color);
            min-width: 28px;
            font-size: 0.9rem;
        }
        
        .student-list-item .student-name {
            font-weight: normal;
            color: #333;
            margin-bottom: 0;
            font-size: 0.9rem;
        }
        
        /* 手动选择模式（未开发） */
        .manual-selection-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .manual-selection-controls button {
            flex: 1;
            padding: 8px;
        }
        
        /* 出勤统计 */
        .attendance-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .stat-item {
            background: #f8f9ff;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #666;
        }
        
        /* 概率设置样式 */
        .probability-controls {
            margin-bottom: 12px;
        }
        
        .probability-controls .probability-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .probability-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 0.9rem;
        }
        
        .probability-item:last-child {
            border-bottom: none;
        }
        
        .probability-item .student-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .probability-item .probability-input {
            width: 70px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .probability-item .probability-display {
            width: 45px;
            text-align: center;
            font-size: 0.85rem;
            color: #666;
        }
        
        .probability-summary {
            background: #f8f9ff;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .probability-summary .sum-display {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .probability-summary .sum-error {
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        .probability-buttons {
            display: flex;
            gap: 8px;
        }
        
        .probability-buttons button {
            flex: 1;
            padding: 8px;
        }
        
        /* 头像上传样式 */
        .avatar-upload-btn {
            padding: 4px 8px;
            background: #f0f4ff;
            border: 1px solid #d1ddff;
            border-radius: 4px;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 5px;
        }
        
        .avatar-upload-btn:hover {
            background: #e0e8ff;
        }
        
        .avatar-preview {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #d1ddff;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f9ff;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-preview i {
            color: #b8c9ff;
            font-size: 1.1rem;
        }
        
        .avatar-input {
            display: none;
        }
        
        /* 学生管理样式 */
        .student-management-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 12px;
        }
        
        .student-management-item {
            padding: 10px;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .student-management-item:last-child {
            border-bottom: none;
        }
        
        .student-management-avatar {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f9ff;
            border: 2px solid #d1ddff;
            flex-shrink: 0;
        }
        
        .student-management-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .student-management-avatar i {
            color: #b8c9ff;
            font-size: 1.5rem;
        }
        
        .student-management-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .student-management-number {
            font-weight: bold;
            color: var(--secondary-color);
            font-size: 0.9rem;
        }
        
        .student-management-name-input {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .student-management-actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .student-management-upload-btn {
            padding: 5px 8px;
            background: #f0f4ff;
            border: 1px solid #d1ddff;
            border-radius: 4px;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .student-management-upload-btn:hover {
            background: #e0e8ff;
        }
        
        .student-management-remove-btn {
            padding: 5px 8px;
            background: #ffeaea;
            border: 1px solid #ffd1d1;
            border-radius: 4px;
            color: #e74c3c;
            cursor: pointer;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .student-management-remove-btn:hover {
            background: #ffdbdb;
        }
        
        /* 点击屏幕提示 */
        .click-hint {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 0.9rem;
            z-index: 100;
            pointer-events: none;
            opacity: 0.8;
            animation: fadeInOut 3s infinite;
        }
        
        /* 特殊学生特效 */
        .special-effect-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 5000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .special-effect-overlay.active {
            display: flex;
        }
        
        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .special-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .skip-video-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid white;
            border-radius: 30px;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s;
        }
        
        .skip-video-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .celebration-container {
            text-align: center;
            padding: 40px;
            display: none;
            flex-direction: column;
            align-items: center;
            animation: celebrationAppear 1s ease-out;
        }
        
        .celebration-container.active {
            display: flex;
        }
        
        .celebration-avatar {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            overflow: hidden;
            border: 6px solid gold;
            margin-bottom: 20px;
            animation: pulseAvatar 2s infinite;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.6);
        }
        
        .celebration-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .celebration-name {
            font-size: 2.5rem;
            color: gold;
            margin-bottom: 15px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            animation: glowText 2s infinite alternate;
        }
        
        .celebration-stars {
            font-size: 2.2rem;
            color: gold;
            margin-bottom: 20px;
            letter-spacing: 8px;
            animation: bounceStars 1.5s infinite;
        }
        
        .celebration-message {
            font-size: 1.5rem;
            color: white;
            max-width: 600px;
            line-height: 1.6;
            margin-bottom: 30px;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        
        .celebration-close-btn {
            background: linear-gradient(to right, #ff9a00, #ff5e00);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 40px;
            cursor: pointer;
            box-shadow: 0 6px 15px rgba(255, 94, 0, 0.3);
            transition: all 0.3s;
        }
        
        .celebration-close-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 94, 0, 0.4);
        }
        
        /* 动画效果 */
        @keyframes selectEffect {
            0% { 
                transform: scale(0.8); 
                opacity: 0.5; 
                box-shadow: 0 0 0 rgba(74, 111, 165, 0);
            }
            50% { 
                transform: scale(1.05); 
                opacity: 1; 
                box-shadow: 0 0 25px rgba(74, 111, 165, 0.6);
            }
            100% { 
                transform: scale(1); 
                opacity: 1; 
                box-shadow: 0 0 20px rgba(74, 111, 165, 0.4);
            }
        }
        
        @keyframes highlightEffect {
            0% { 
                box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            }
            100% { 
                box-shadow: 0 12px 25px rgba(74, 111, 165, 0.3);
                border-color: rgba(74, 111, 165, 0.2);
            }
        }
        
        @keyframes drawingEffect {
            0% { 
                transform: scale(1); 
                opacity: 0.8;
            }
            100% { 
                transform: scale(1.05); 
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(15px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0.3; }
            50% { opacity: 0.8; }
            100% { opacity: 0.3; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes messageAppear {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes celebrationAppear {
            0% { 
                opacity: 0; 
                transform: scale(0.5); 
            }
            70% { 
                opacity: 1; 
                transform: scale(1.05); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1); 
            }
        }
        
        @keyframes pulseAvatar {
            0% { 
                transform: scale(1); 
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.6);
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 0 60px rgba(255, 215, 0, 0.8);
            }
            100% { 
                transform: scale(1); 
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.6);
            }
        }
        
        @keyframes glowText {
            0% { 
                text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            }
            100% { 
                text-shadow: 0 0 20px rgba(255, 215, 0, 0.9), 0 0 30px rgba(255, 215, 0, 0.5);
            }
        }
        
        @keyframes bounceStars {
            0%, 100% { 
                transform: translateY(0); 
            }
            50% { 
                transform: translateY(-10px); 
            }
        }
        
        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        .pulse {
            animation: pulse 0.5s infinite;
        }
        
        .spinning {
            animation: spin 0.8s linear infinite;
        }
        
        /* 抽取动画 */
        .drawing-animation {
            animation: drawingEffect 0.5s infinite alternate;
            background: linear-gradient(135deg, #ffcc00, #ff9a00);
        }
        
        /* 覆盖层 */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }
        
        /* 移除大部分响应式设计，只保留必要的 */
        @media (max-width: 768px) {
            /* 保留基本响应式，但简化 */
            body {
                padding: 5px;
            }
            
            .container {
                height: 95vh;
                border-radius: 10px;
            }
            
            .result-display {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .student-management-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .student-management-avatar {
                width: 50px;
                height: 50px;
            }
            
            /* 留言板在手机上的响应式 */
            .chat-modal {
                width: 95%;
                height: 90vh;
                max-height: none;
            }
            
            .chat-users {
                width: 200px;
            }
            
            .celebration-name {
                font-size: 2rem;
            }
            
            .celebration-message {
                font-size: 1.2rem;
                padding: 0 20px;
            }
            
            /* 公告栏在手机上的响应式 */
            .announcement-container {
                margin: 0 5px;
                height: 36px;
                padding: 6px 10px;
            }
            
            .announcement-icon {
                font-size: 1rem;
                margin-right: 8px;
            }
            
            .announcement-content {
                font-size: 0.9rem;
            }
        }
        
        /* 完全移除手机端的媒体查询，只保留电脑端 */
        
        footer {
            text-align: center;
            padding: 10px;
            color: #6c757d;
            font-size: 0.85rem;
            border-top: 1px solid #eee;
        }
        
        /* 加载占位符 */
        .placeholder-card {
            text-align: center;
            color: #666;
            padding: 30px;
            width: 100%;
        }
        
        .placeholder-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #b8c9ff;
        }
        
        /* 操作说明 */
        .instructions {
            background: #f8f9ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 3px solid var(--accent-color);
        }
        
        .instructions h4 {
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-size: 1rem;
        }
        
        .instructions ul {
            padding-left: 18px;
            margin-bottom: 0;
        }
        
        .instructions li {
            margin-bottom: 4px;
            line-height: 1.5;
            font-size: 0.9rem;
        }
        
        /* 主题颜色 */
        .theme-blue {
            --primary-color: #4a6fa5;
            --secondary-color: #3a5a8c;
            --accent-color: #ff9a00;
            --gradient-start: #6a11cb;
            --gradient-end: #2575fc;
            --message-text-color: #333333;
            --message-own-text-color: #ffffff;
        }
        
        .theme-green {
            --primary-color: #2ecc71;
            --secondary-color: #27ae60;
            --accent-color: #f39c12;
            --gradient-start: #0ba360;
            --gradient-end: #3cba92;
            --message-text-color: #333333;
            --message-own-text-color: #ffffff;
        }
        
        .theme-purple {
            --primary-color: #9b59b6;
            --secondary-color: #8e44ad;
            --accent-color: #e74c3c;
            --gradient-start: #7F00FF;
            --gradient-end: #E100FF;
            --message-text-color: #333333;
            --message-own-text-color: #ffffff;
        }
        
        .theme-red {
            --primary-color: #e74c3c;
            --secondary-color: #c0392b;
            --accent-color: #f1c40f;
            --gradient-start: #ED213A;
            --gradient-end: #93291E;
            --message-text-color: #333333;
            --message-own-text-color: #ffffff;
        }
        
        .theme-dark {
            --primary-color: #34495e;
            --secondary-color: #2c3e50;
            --accent-color: #3498db;
            --gradient-start: #2C3E50;
            --gradient-end: #4CA1AF;
            --message-text-color: #ffffff;
            --message-own-text-color: #ffffff;
        }
        
        .theme-orange {
            --primary-color: #e67e22;
            --secondary-color: #d35400;
            --accent-color: #1abc9c;
            --gradient-start: #FF8008;
            --gradient-end: #FFC837;
            --message-text-color: #333333;
            --message-own-text-color: #ffffff;
        }
        
        /* 头像加载状态 */
        .avatar-loading {
            background: linear-gradient(90deg, #f0f4ff 0%, #e8f0ff 50%, #f0f4ff 100%);
            background-size: 200% 100%;
            animation: loadingAnimation 1.5s infinite;
        }
        
        @keyframes loadingAnimation {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* 抽取信息面板 */
        .info-panel {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 300px;
            margin-bottom: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #666;
        }
        
        .info-value {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        /* 图片选择器样式 - 已修复 */
        .image-selector-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 800px;
            height: 80vh;
            max-height: 700px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            z-index: 4000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .image-selector-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .image-selector-header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .image-selector-header h4 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .image-selector-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .image-selector-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .image-selector-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            align-content: start;
            max-height: calc(80vh - 150px);
        }
        
        .image-selector-item {
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            height: 160px;
        }
        
        .image-selector-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .image-selector-item.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(74, 111, 165, 0.3);
        }
        
        .image-selector-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        
        .image-selector-filename {
            padding: 8px;
            background: #f8f9ff;
            font-size: 0.85rem;
            text-align: center;
            word-break: break-all;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-selector-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .image-selector-empty i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #b8c9ff;
        }
        
        .image-selector-actions {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* 聊天图片上传按钮 */
        .chat-image-input {
            display: none;
        }
        
        .chat-upload-progress {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9ff;
            border-radius: 8px;
            display: none;
        }
        
        .chat-upload-progress.active {
            display: block;
        }
        
        .chat-upload-progress-bar {
            height: 8px;
            background: #e0e8ff;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .chat-upload-progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 0.3s;
        }
        
        /* 文字颜色选择器 */
        .text-color-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .text-color-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.active {
            border-color: #333;
            transform: scale(1.1);
        }
        
        .color-black {
            background-color: #333333;
        }
        
        .color-blue {
            background-color: #4a6fa5;
        }
        
        .color-red {
            background-color: #e74c3c;
        }
        
        .color-green {
            background-color: #2ecc71;
        }
        
        .color-purple {
            background-color: #9b59b6;
        }
        
        .color-orange {
            background-color: #e67e22;
        }
        
        /* 优化图片加载 */
        .image-thumbnail {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background-color: #f5f5f5;
        }
        
        /* 消息优化 */
        .message-optimized {
            will-change: transform, opacity;
        }
        
        /* 聊天设置按钮 */
        .chat-settings-btn {
            margin-top: 10px;
            width: 100%;
        }
        
        /* 特殊学生设置 */
        .special-student-item {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .special-student-item:last-child {
            border-bottom: none;
        }
        
        .special-student-name {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
    </style>
</head>
<body class="theme-blue">
    <!-- 点击屏幕提示 -->
    <div class="click-hint" id="clickHint">
        <i class="fas fa-hand-pointer"></i> 2025.12.15
    </div>
    
    <!-- 特殊学生特效 -->
    <div class="special-effect-overlay" id="specialEffectOverlay">
        <div class="video-container" id="videoContainer">
            <video class="special-video" id="specialVideo" preload="auto">
                您的浏览器不支持视频播放
            </video>
            <button class="skip-video-btn" id="skipVideoBtn">
                <i class="fas fa-forward"></i> 跳过视频
            </button>
        </div>
        <div class="celebration-container" id="celebrationContainer">
            <div class="celebration-avatar">
                <img id="celebrationAvatar" src="" alt="特殊学生">
            </div>
            <div class="celebration-name" id="celebrationName"></div>
            <div class="celebration-stars">⭐⭐⭐⭐⭐</div>
            <div class="celebration-message" id="celebrationMessage"></div>
            <button class="celebration-close-btn" id="celebrationCloseBtn">
                <i class="fas fa-check-circle"></i> 确认
            </button>
        </div>
    </div>
    
    <div class="container">
        <!-- 头部 -->
        <header>
            <div class="logo">
                <i class="fas fa-chalkboard-teacher"></i>
                <h1>高三（1）班点名器</h1>
            </div>
            
            <!-- 公告栏 -->
            <div class="announcement-container">
                <div class="announcement-icon">
                    <i class="fas fa-bullhorn"></i>
                </div>
                <div class="announcement-content">
                    <div class="announcement-scroll" id="announcementText">
                        正在加载公告...
                    </div>
                </div>
            </div>
            
            <div class="header-controls">
                <!-- 添加留言板按钮 -->
                <button class="chat-toggle" id="chatToggle">
                    <i class="fas fa-comments"></i>
                    <div class="chat-notification hidden" id="chatNotification"></div>
                </button>
                
                <a href="https://wpa.qq.com/msgrd?v=3&uin=2793694488&site=qq&menu=yes" class="qq-avatar" target="_blank" title="联系开发者">
                    <img src="https://q1.qlogo.cn/g?b=qq&nk=2793694488&s=640" alt="QQ头像">
                </a>
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i> <span>菜单</span>
                </button>
            </div>
        </header>
        
        <!-- 主要内容区 -->
        <div class="main-content">
            <!-- 左边面板 - 开始点名按钮和抽取人数选择 -->
            <div class="left-panel">
                <div class="number-selector-container">
                    <h3><i class="fas fa-user-friends"></i> 选择抽取人数</h3>
                    <div class="number-selector">
                        <button class="number-btn active" data-count="1">1</button>
                        <button class="number-btn" data-count="2">2</button>
                        <button class="number-btn" data-count="3">3</button>
                        <button class="number-btn" data-count="4">4</button>
                        <button class="number-btn" data-count="5">5</button>
                    </div>
                    <p style="font-size: 0.85rem; color: #666; text-align: center;">点击数字选择抽取人数</p>
                </div>
                
                <button class="start-btn" id="startBtn">
                    <i class="fas fa-play-circle"></i>
                    <span>开始点名</span>
                </button>
                
                <div class="info-panel">
                    <div class="info-item">
                        <span class="info-label">总人数:</span>
                        <span class="info-value" id="totalStudents">70</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">已抽取:</span>
                        <span class="info-value" id="drawnCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">模式:</span>
                        <span class="info-value" id="modeStatus">随机点名</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">状态:</span>
                        <span class="info-value" id="statusReady">准备就绪</span>
                    </div>
                </div>
            </div>
            
            <!-- 右边面板 - 结果区域 -->
            <div class="right-panel">
                <div class="result-container">
                    <div class="result-title">
                        <i class="fas fa-user-graduate"></i>
                        <span id="resultTitle">等待点名...</span>
                    </div>
                    <div class="result-display" id="resultDisplay">
                        <!-- 这里显示抽取结果 -->
                        <div class="placeholder-card">
                            <i class="fas fa-users"></i>
                            <p style="font-size: 1.1rem;">点击"开始点名"按钮开始抽取</p>
                            <p style="font-size: 0.85rem; color: #888; margin-top: 8px;">2025.12.15</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 页脚 -->
        <footer>
            <p>高三（1）班专用点名器 | 共70名学生 | 设计：高三（1）班技术小组</p>
        </footer>
        
        <!-- 留言板弹窗 -->
        <div class="chat-modal" id="chatModal">
            <div class="chat-header">
                <h3><i class="fas fa-comments"></i> 高三（1）班留言板</h3>
                <button class="chat-close" id="chatClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="chat-content">
                <!-- 用户列表 -->
                <div class="chat-users">
                    <h4><i class="fas fa-users"></i> 在线成员</h4>
                    <div class="user-list" id="userList">
                        <!-- 用户列表会动态生成 -->
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4><i class="fas fa-user-cog"></i> 用户设置</h4>
                        <div class="text-color-selector">
                            <span class="text-color-label">文字颜色:</span>
                            <div class="color-option color-black active" data-color="#333333" title="黑色"></div>
                            <div class="color-option color-blue" data-color="#4a6fa5" title="蓝色"></div>
                            <div class="color-option color-red" data-color="#e74c3c" title="红色"></div>
                            <div class="color-option color-green" data-color="#2ecc71" title="绿色"></div>
                            <div class="color-option color-purple" data-color="#9b59b6" title="紫色"></div>
                            <div class="color-option color-orange" data-color="#e67e22" title="橙色"></div>
                        </div>
                        <button class="btn btn-primary" id="openUserSettings" style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-user-edit"></i> 修改个人信息
                        </button>
                        <button class="btn btn-primary chat-settings-btn" id="openChatSettings">
                            <i class="fas fa-cog"></i> 留言板设置
                        </button>
                    </div>
                </div>
                
                <!-- 聊天主区域 -->
                <div class="chat-main">
                    <!-- 消息列表 -->
                    <div class="messages-container" id="messagesContainer">
                        <div class="welcome-message">
                            <div class="message">
                                <div class="message-avatar">
                                    <i class="fas fa-robot" style="font-size: 1.5rem; color: #4a6fa5; display: flex; align-items: center; justify-content: center; height: 100%;"></i>
                                    <div class="message-sender-name">系统消息</div>
                                </div>
                                <div class="message-content">
                                    <div class="message-header">
                                        <div class="message-sender">系统消息</div>
                                        <div class="message-time">刚刚</div>
                                    </div>
                                    <div class="message-text">
                                        欢迎来到高三（1）班留言板！我是小钊，您可以在这里与同学们交流。
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 图片上传进度 -->
                    <div class="chat-upload-progress" id="chatUploadProgress">
                        <div>正在上传图片...</div>
                        <div class="chat-upload-progress-bar">
                            <div class="chat-upload-progress-fill" id="chatUploadProgressFill"></div>
                        </div>
                    </div>
                    
                    <!-- 回复预览 -->
                    <div class="reply-preview" id="replyPreview" style="display: none;">
                        <div class="reply-indicator">
                            <div>
                                <span>正在回复：</span>
                                <span class="reply-sender" id="replySenderName"></span>
                                <span id="replyPreviewText"></span>
                            </div>
                            <div class="cancel-reply" id="cancelReply">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 聊天输入区域 -->
                    <div class="chat-input-area">
                        <div class="chat-input-container">
                            <textarea class="chat-input" id="chatInput" placeholder="输入消息..."></textarea>
                            <div class="chat-actions">
                                <button class="chat-action-btn" id="imageUploadBtn" title="上传图片">
                                    <i class="fas fa-image"></i>
                                </button>
                                <input type="file" id="chatImageInput" class="chat-image-input" accept="image/gif,image/jpeg,image/jpg,image/png,image/webp">
                                <button class="chat-action-btn" id="selectImageBtn" title="选择图片">
                                    <i class="fas fa-folder-open"></i>
                                </button>
                                <button class="chat-action-btn send-btn" id="sendMessageBtn" title="发送消息">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 用户设置弹窗 -->
        <div class="user-settings-modal" id="userSettingsModal">
            <div class="user-settings-header">
                <h4><i class="fas fa-user-edit"></i> 个人信息设置</h4>
            </div>
            
            <div class="avatar-upload-area">
                <div class="avatar-preview-large" id="avatarPreviewLarge">
                    <img src="" alt="用户头像" id="currentAvatar">
                    <div class="avatar-change-btn">点击更换</div>
                </div>
                
                <div class="avatar-upload-btns">
                    <button class="avatar-upload-btn" id="uploadImageBtn">
                        <i class="fas fa-upload"></i> 上传图片
                    </button>
                    <button class="avatar-upload-btn" id="selectFromImagesBtn">
                        <i class="fas fa-folder-open"></i> 从images选择
                    </button>
                </div>
                
                <input type="file" id="avatarUploadInput" accept="image/gif,image/jpeg,image/jpg,image/png,image/webp" style="display: none;">
            </div>
            
            <input type="text" class="user-name-input" id="userNameInput" placeholder="请输入您的用户名">
            
            <div class="user-settings-buttons">
                <button class="settings-cancel-btn" id="cancelSettingsBtn">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button class="settings-save-btn" id="saveSettingsBtn">
                    <i class="fas fa-save"></i> 保存设置
                </button>
            </div>
        </div>
        
        <!-- 留言板设置弹窗 -->
        <div class="chat-settings-modal" id="chatSettingsModal">
            <div class="chat-settings-header">
                <h4><i class="fas fa-cog"></i> 留言板设置</h4>
            </div>
            
            <div class="chat-setting-item">
                <label>消息显示方式</label>
                <select id="messageDisplayMode">
                    <option value="compact">紧凑模式</option>
                    <option value="normal" selected>普通模式</option>
                    <option value="comfortable">舒适模式</option>
                </select>
            </div>
            
            .chat-setting-item {
                <label>消息时间显示</label>
                <select id="messageTimeDisplay">
                    <option value="relative" selected>相对时间(刚刚，5分钟前)</option>
                    <option value="absolute">绝对时间(12:30)</option>
                    <option value="hidden">隐藏时间</option>
                </select>
            </div>
            
            <div class="chat-setting-item">
                <label>图片显示质量</label>
                <select id="imageQuality">
                    <option value="low">低质量(快速加载)</option>
                    <option value="medium" selected>中等质量</option>
                    <option value="high">高质量</option>
                </select>
            </div>
            
            <div class="chat-setting-item">
                <label>消息通知</label>
                <select id="messageNotification">
                    <option value="all">所有消息</option>
                    <option value="mentions" selected>仅提到我的</option>
                    <option value="none">不通知</option>
                </select>
            </div>
            
            <button class="clear-chat-btn" id="clearChatHistoryBtn">
                <i class="fas fa-trash"></i> 清空聊天记录
            </button>
            
            <div class="chat-settings-buttons">
                <button class="btn btn-secondary" id="cancelChatSettingsBtn">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button class="btn btn-primary" id="saveChatSettingsBtn">
                    <i class="fas fa-save"></i> 保存设置
                </button>
            </div>
        </div>
        
        <!-- 图片预览弹窗 -->
        <div class="image-preview-modal" id="imagePreviewModal">
            <div class="image-preview-content">
                <img src="" alt="预览图片" id="previewedImage">
            </div>
            <button class="close-image-preview" id="closeImagePreview">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- 图片选择器弹窗 - 已修复 -->
        <div class="image-selector-modal" id="imageSelectorModal">
            <div class="image-selector-header">
                <h4><i class="fas fa-images"></i> 选择图片</h4>
                <button class="image-selector-close" id="imageSelectorClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="image-selector-content" id="imageSelectorContent">
                <!-- 图片列表会动态生成 -->
            </div>
            
            <div class="image-selector-actions">
                <button class="btn btn-secondary" id="cancelImageSelectBtn">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button class="btn btn-primary" id="confirmImageSelectBtn">
                    <i class="fas fa-check"></i> 确认选择
                </button>
            </div>
        </div>
        
        <!-- 侧边菜单 -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-sliders-h"></i> 点名器设置</h2>
                <button class="close-menu" id="closeMenu">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- 操作说明 -->
            <div class="instructions">
                <h4>使用说明</h4>
                <ul>
                    <li>选择抽取人数（1-5人）</li>
                    <li>点击"开始点名"按钮开始抽取</li>
                    <li>在菜单中可进行更多设置</li>
                </ul>
            </div>
            
            <!-- 抽取设置 - 移到菜单中 -->
            <div class="roll-settings-controls">
                <h4><i class="fas fa-cog"></i> 抽取设置</h4>
                <p>抽取时显示动画效果，已排除重复抽取</p>
                <p>总人数: <strong id="totalStudentsMenu">70</strong> 人</p>
                <p>当前排除: <strong id="excludedStudentsCount">0</strong> 人</p>
                <p>概率模式: <strong id="probabilityModeStatus">已启用</strong></p>
                <p>音效: <strong id="soundEffectStatus">已启用</strong></p>
            </div>
            
            <!-- 特殊学生特效设置 -->
            <div class="menu-section">
                <div class="menu-section-header" onclick="toggleMenuSection(this)">
                    <span><i class="fas fa-crown"></i> 特殊学生特效设置</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="menu-section-content">
                    <h4>特殊点名效果</h4>
                    <p>当抽到特殊学生时，显示特殊庆祝效果</p>
                    
                    <div class="setting-control">
                        <label>
                            <input type="checkbox" id="enableSpecialEffect" checked> 启用特殊学生特效
                        </label>
                    </div>
                    
                    <!-- 郭忠辉设置 -->
                    <div class="special-student-item">
                        <div class="special-student-name">郭忠辉 (26号)</div>
                        <div class="setting-control">
                            <label>
                                <input type="checkbox" class="student-video-effect" data-student-id="26" checked> 播放庆祝视频
                            </label>
                        </div>
                        <div class="setting-control">
                            <label>
                                <input type="checkbox" class="student-celebration-effect" data-student-id="26" checked> 显示庆祝画面
                            </label>
                        </div>
                    </div>
                    
                    <!-- 一水大王（朱伍扬）设置 -->
                    <div class="special-student-item">
                        <div class="special-student-name">一水大王（朱伍扬） (48号)</div>
                        <div class="setting-control">
                            <label>
                                <input type="checkbox" class="student-video-effect" data-student-id="48" checked> 播放庆祝视频
                            </label>
                        </div>
                        <div class="setting-control">
                            <label>
                                <input type="checkbox" class="student-celebration-effect" data-student-id="48" checked> 显示庆祝画面
                            </label>
                        </div>
                    </div>
                    
                    <!-- 何发垚设置 -->
                    <div class="special-student-item">
                        <div class="special-student-name">何发垚 (15号)</div>
                        <div class="setting-control">
                            <label>
                                <input type="checkbox" class="student-video-effect" data-student-id="15" checked> 播放庆祝视频
                            </label>
                        </div>
                        <div class="setting-control">
                            <label>
                                <input type="checkbox" class="student-celebration-effect" data-student-id="15" checked> 显示庆祝画面
                            </label>
                        </div>
                    </div>
                    
                    <div class="setting-control">
                        <label>特效音量</label>
                        <input type="range" id="effectVolume" min="0" max="100" value="70">
                    </div>
                    
                    <button class="btn btn-primary" id="saveSpecialEffectSettings">
                        <i class="fas fa-save"></i> 保存设置
                    </button>
                    
                    <p style="font-size:0.85rem; color:#666; margin-top:10px;">
                        <i class="fas fa-info-circle"></i> 特效在抽到特殊学生时触发，可以跳过视频直接查看庆祝画面。
                    </p>
                </div>
            </div>
            
            <!-- 学生管理 -->
            <div class="menu-section">
                <div class="menu-section-header" onclick="toggleMenuSection(this)">
                    <span><i class="fas fa-user-edit"></i> 学生管理</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="menu-section-content">
                    <div id="studentManagementSection">
                        <h4>学生信息管理</h4>
                        <p>可以修改学生姓名和上传头像，学生序号保持不变</p>
                        
                        <div class="student-management-list" id="studentManagementList">
                            <!-- 学生管理列表将在这里动态生成 -->
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <button class="btn btn-secondary" id="resetStudentNamesBtn">
                                <i class="fas fa-redo"></i> 恢复默认姓名
                            </button>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <button class="btn btn-secondary" id="clearAllAvatarsBtn">
                                <i class="fas fa-trash"></i> 清除所有头像
                            </button>
                        </div>
                        
                        <button class="btn btn-primary" id="saveStudentManagementBtn">
                            <i class="fas fa-save"></i> 保存所有修改
                        </button>
                        
                        <p style="font-size:0.85rem; color:#666; margin-top:10px;">
                            <i class="fas fa-info-circle"></i> 支持上传的图片格式：GIF、JPG、JPEG、PNG、WEBP。头像将保存到浏览器本地存储中。
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- 排除学生设置 -->
            <div class="menu-section">
                <div class="menu-section-header" onclick="toggleMenuSection(this)">
                    <span><i class="fas fa-user-minus"></i> 排除学生设置</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="menu-section-content">
                    <h4>选择不参与点名的学生</h4>
                    <p>勾选的学生将不会被随机点名选中</p>
                    
                    <div class="student-list-view" id="excludeStudentListView">
                        <!-- 排除学生列表将动态生成 -->
                    </div>
                    
                    <div class="manual-selection-controls">
                        <button class="btn btn-secondary" id="excludeAllBtn">
                            <i class="fas fa-check-square"></i> 全选
                        </button>
                        <button class="btn btn-secondary" id="includeAllBtn">
                            <i class="fas fa-square"></i> 全不选
                        </button>
                    </div>
                    
                    <p>已排除 <span id="excludedCount">0</span> 名学生</p>
                    
                    <button class="btn btn-primary" id="saveExcludedBtn">
                        <i class="fas fa-save"></i> 保存排除设置
                    </button>
                </div>
            </div>
            
            <!-- 概率设置 -->
            <div class="menu-section">
                <div class="menu-section-header" onclick="toggleMenuSection(this)">
                    <span><i class="fas fa-percentage"></i> 学生概率设置</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="menu-section-content">
                    <div id="probabilitySettingsSection">
                        <h4>学生点名概率</h4>
                        <p>为每个学生设置被点到的概率，所有概率总和应为1</p>
                        
                        <div class="probability-summary">
                            <div>当前概率总和: <span class="sum-display" id="probabilitySum">1.00</span></div>
                            <div class="sum-error" id="probabilityError" style="display:none">概率总和必须为1！</div>
                        </div>
                        
                        <div class="probability-controls">
                            <div class="probability-list" id="probabilityList">
                                <!-- 学生概率列表将在这里动态生成 -->
                            </div>
                            
                            <div class="probability-buttons">
                                <button class="btn btn-secondary" id="resetProbabilitiesBtn">
                                    <i class="fas fa-redo"></i> 重置为平均
                                </button>
                                <button class="btn btn-primary" id="saveProbabilitiesBtn">
                                    <i class="fas fa-save"></i> 保存概率设置
                                </button>
                            </div>
                        </div>
                        
                        <div class="setting-control">
                            <label>
                                <input type="checkbox" id="enableProbability" checked> 启用概率点名模式
                            </label>
                        </div>
                        
                        <p style="font-size:0.85rem; color:#666; margin-top:10px;">
                            <i class="fas fa-info-circle"></i> 概率越高，被点到的可能性越大。概率总和必须为1，否则无法保存。
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- 随机点名设置 -->
            <div class="menu-section">
                <div class="menu-section-header" onclick="toggleMenuSection(this)">
                    <span><i class="fas fa-random"></i> 随机点名设置</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="menu-section-content">
                    <h4>点名模式</h4>
                    <div class="setting-control">
                        <label>
                            <input type="radio" name="rollMode" value="random" checked> 完全随机
                        </label>
                        <label>
                            <input type="radio" name="rollMode" value="sequential"> 顺序点名
                        </label>
                        <label>
                            <input type="radio" name="rollMode" value="group"> 分组点名
                        </label>
                    </div>
                    
                    <h4>防重复设置</h4>
                    <div class="setting-control">
                        <label>
                            <input type="checkbox" id="preventRepeat" checked> 防止连续点到同一学生
                        </label>
                    </div>
                    
                    <h4>排除名单</h4>
                    <div class="setting-control">
                        <label>
                            <input type="checkbox" id="excludeAbsent"> 自动排除已请假学生
                        </label>
                    </div>
                    
                    <div class="setting-control">
                        <label>
                            <input type="checkbox" id="excludeManual" checked> 排除手动选择的学生
                        </label>
                    </div>
                    
                    <button class="btn btn-primary" id="saveRollSettings">
                        <i class="fas fa-save"></i> 保存设置
                    </button>
                </div>
            </div>
            
            <!-- 点名动画效果 -->
            <div class="menu-section">
                <div class="menu-section-header" onclick="toggleMenuSection(this)">
                    <span><i class="fas fa-film"></i> 点名动画效果</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="menu-section-content">
                    <h4>动画设置</h4>
                    <div class="setting-control">
                        <label>
                            <input type="checkbox" id="enableAnimation" checked> 启用点名动画
                        </label>
                    </div>
                    
                    <div class="setting-control">
                        <label>动画速度</label>
                        <select id="animationSpeed">
                            <option value="slow">慢速</option>
                            <option value="normal" selected>正常</option>
                            <option value="fast">快速</option>
                        </select>
                    </div>
                    
                    <div class="setting-control">
                        <label>高亮效果</label>
                        <select id="highlightEffect">
                            <option value="glow">发光效果</option>
                            <option value="pulse" selected>脉冲效果</option>
                            <option value="bounce">弹跳效果</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" id="saveAnimationSettings">
                        <i class="fas fa-save"></i> 保存设置
                    </button>
                </div>
            </div>
            
            <!-- 设置与个性化 -->
            <div class="menu-section">
                <div class="menu-section-header" onclick="toggleMenuSection(this)">
                    <span><i class="fas fa-cogs"></i> 设置与个性化</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="menu-section-content">
                    <h4>界面定制</h4>
                    <div class="setting-control">
                        <label>主题颜色</label>
                        <select id="themeSelect">
                            <option value="blue" selected>蓝色经典</option>
                            <option value="green">绿色清新</option>
                            <option value="purple">紫色浪漫</option>
                            <option value="red">红色激情</option>
                            <option value="dark">深色模式</option>
                            <option value="orange">橙色活力</option>
                        </select>
                    </div>
                    
                    <h4>音效设置</h4>
                    <div class="setting-control">
                        <label>
                            <input type="checkbox" id="enableSound" checked> 启用点名音效
                        </label>
                    </div>
                    
                    <div class="setting-control">
                        <label>音效类型</label>
                        <select id="soundType">
                            <option value="ding" selected>清脆铃声</option>
                            <option value="buzz">蜂鸣声</option>
                            <option value="bell">钟声</option>
                            <option value="click">点击声</option>
                            <option value="windup">发条音效</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" id="saveGeneralSettings">
                        <i class="fas fa-save"></i> 保存设置
                    </button>
                </div>
            </div>
            
            <!-- 关于 -->
            <div class="menu-section">
                <div class="menu-section-header" onclick="toggleMenuSection(this)">
                    <span><i class="fas fa-info-circle"></i> 关于</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="menu-section-content">
                    <h4>系统信息</h4>
                    <p><strong>版本:</strong> 3.3.0</p>
                    <p><strong>开发者:</strong> 高三（1）班技术小组</p>
                    <p><strong>联系方式:</strong> QQ: 2793694488 微信：h497076531</p>
                    <p><strong>作者声明:</strong> 这款点名器用html开发github代理</p>
                    
                    <h4>数据安全</h4>
                    <p>所有数据仅存储在本地浏览器中，不会上传到任何服务器，保护您的隐私安全。</p>
                    
                    <button class="btn btn-secondary" id="clearDataBtn" style="margin-top: 15px;">
                        <i class="fas fa-trash"></i> 清除所有数据
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 密码验证框 -->
        <div class="password-overlay" id="passwordOverlay">
            <div class="password-dialog">
                <h3><i class="fas fa-lock"></i> 请输入密码</h3>
                <input type="password" id="passwordInput" class="password-input" placeholder="请输入访问密码">
                <p id="passwordError" style="color: #e74c3c; margin-top: 10px; display: none;">密码错误，请重试！</p>
                <div class="password-buttons">
                    <button class="btn btn-secondary" id="cancelPasswordBtn">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button class="btn btn-primary" id="submitPasswordBtn">
                        <i class="fas fa-check"></i> 确认
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 覆盖层 -->
        <div class="overlay" id="overlay"></div>
    </div>
    <script>
    // 学生数据 - 固定70人
    let students = [
        {name: "李宇滔", probability: 1/70, attendance: "present", avatar: null, studentId: 1, excluded: false},
        {name: "张奕", probability: 1/70, attendance: "present", avatar: null, studentId: 2, excluded: false},
        {name: "钟惠映", probability: 1/70, attendance: "present", avatar: null, studentId: 3, excluded: false},
        {name: "谢敏怡", probability: 1/70, attendance: "present", avatar: null, studentId: 4, excluded: false},
        {name: "郭星", probability: 1/70, attendance: "present", avatar: null, studentId: 5, excluded: false},
        {name: "何树坤", probability: 1/70, attendance: "present", avatar: null, studentId: 6, excluded: false},
        {name: "莫海桃", probability: 1/70, attendance: "present", avatar: null, studentId: 7, excluded: false},
        {name: "吕彩滢", probability: 1/70, attendance: "present", avatar: null, studentId: 8, excluded: false},
        {name: "张海涛", probability: 1/70, attendance: "present", avatar: null, studentId: 9, excluded: false},
        {name: "赖保成", probability: 1/70, attendance: "present", avatar: null, studentId: 10, excluded: false},
        {name: "龚彦普", probability: 1/70, attendance: "present", avatar: null, studentId: 11, excluded: false},
        {name: "郭永精", probability: 1/70, attendance: "present", avatar: null, studentId: 12, excluded: false},
        {name: "林传武", probability: 1/70, attendance: "present", avatar: null, studentId: 13, excluded: false},
        {name: "何金泉", probability: 1/70, attendance: "present", avatar: null, studentId: 14, excluded: false},
        {name: "何发垚", probability: 1/70, attendance: "present", avatar: null, studentId: 15, excluded: false},
        {name: "车锦旭", probability: 1/70, attendance: "present", avatar: null, studentId: 16, excluded: false},
        {name: "李梓盛", probability: 1/70, attendance: "present", avatar: null, studentId: 17, excluded: false},
        {name: "苏晓煜", probability: 1/70, attendance: "present", avatar: null, studentId: 18, excluded: false},
        {name: "萧枫", probability: 1/70, attendance: "present", avatar: null, studentId: 19, excluded: false},
        {name: "何伟业", probability: 1/70, attendance: "present", avatar: null, studentId: 20, excluded: false},
        {name: "苏艳冰", probability: 1/70, attendance: "present", avatar: null, studentId: 21, excluded: false},
        {name: "何美玲", probability: 1/70, attendance: "present", avatar: null, studentId: 22, excluded: false},
        {name: "杨宇鹏", probability: 1/70, attendance: "present", avatar: null, studentId: 23, excluded: false},
        {name: "林华城", probability: 1/70, attendance: "present", avatar: null, studentId: 24, excluded: false},
        {name: "何宇钊", probability: 1/70, attendance: "present", avatar: null, studentId: 25, excluded: false},
        {name: "郭忠辉", probability: 1/70, attendance: "present", avatar: null, studentId: 26, excluded: false},
        {name: "朱键铭", probability: 1/70, attendance: "present", avatar: null, studentId: 27, excluded: false},
        {name: "林子翔", probability: 1/70, attendance: "present", avatar: null, studentId: 28, excluded: false},
        {name: "张华锦", probability: 1/70, attendance: "present", avatar: null, studentId: 29, excluded: false},
        {name: "刘谦", probability: 1/70, attendance: "present", avatar: null, studentId: 30, excluded: false},
        {name: "黎晓雯", probability: 1/70, attendance: "present", avatar: null, studentId: 31, excluded: false},
        {name: "车思慧", probability: 1/70, attendance: "present", avatar: null, studentId: 32, excluded: false},
        {name: "黄庆运", probability: 1/70, attendance: "present", avatar: null, studentId: 33, excluded: false},
        {name: "詹志涛", probability: 1/70, attendance: "present", avatar: null, studentId: 34, excluded: false},
        {name: "钟汶晓", probability: 1/70, attendance: "present", avatar: null, studentId: 35, excluded: false},
        {name: "钟懿晴", probability: 1/70, attendance: "present", avatar: null, studentId: 36, excluded: false},
        {name: "李婷婷", probability: 1/70, attendance: "present", avatar: null, studentId: 37, excluded: false},
        {name: "叶宁洪", probability: 1/70, attendance: "present", avatar: null, studentId: 38, excluded: false},
        {name: "欧秋堂", probability: 1/70, attendance: "present", avatar: null, studentId: 39, excluded: false},
        {name: "王志城", probability: 1/70, attendance: "present", avatar: null, studentId: 40, excluded: false},
        {name: "张景恒", probability: 1/70, attendance: "present", avatar: null, studentId: 41, excluded: false},
        {name: "吕洛", probability: 1/70, attendance: "present", avatar: null, studentId: 42, excluded: false},
        {name: "梁德铿", probability: 1/70, attendance: "present", avatar: null, studentId: 43, excluded: false},
        {name: "吴健星", probability: 1/70, attendance: "present", avatar: null, studentId: 44, excluded: false},
        {name: "李增强", probability: 1/70, attendance: "present", avatar: null, studentId: 45, excluded: false},
        {name: "张棋峰", probability: 1/70, attendance: "present", avatar: null, studentId: 46, excluded: false},
        {name: "梁连柯", probability: 1/70, attendance: "present", avatar: null, studentId: 47, excluded: false},
        {name: "一水大王（朱伍扬）", probability: 1/70, attendance: "present", avatar: null, studentId: 48, excluded: false},
        {name: "凌炜钦", probability: 1/70, attendance: "present", avatar: null, studentId: 49, excluded: false},
        {name: "罗世鸿", probability: 1/70, attendance: "present", avatar: null, studentId: 50, excluded: false},
        {name: "梁昊铭", probability: 1/70, attendance: "present", avatar: null, studentId: 51, excluded: false},
        {name: "赖剑锋", probability: 1/70, attendance: "present", avatar: null, studentId: 52, excluded: false},
        {name: "卢权颖", probability: 1/70, attendance: "present", avatar: null, studentId: 53, excluded: false},
        {name: "黄梓铭", probability: 1/70, attendance: "present", avatar: null, studentId: 54, excluded: false},
        {name: "陈洪远", probability: 1/70, attendance: "present", avatar: null, studentId: 55, excluded: false},
        {name: "苏荣锦", probability: 1/70, attendance: "present", avatar: null, studentId: 56, excluded: false},
        {name: "叶贵佳", probability: 1/70, attendance: "present", avatar: null, studentId: 57, excluded: false},
        {name: "林杰龙", probability: 1/70, attendance: "present", avatar: null, studentId: 58, excluded: false},
        {name: "吕俊威", probability: 1/70, attendance: "present", avatar: null, studentId: 59, excluded: false},
        {name: "崔杨坚", probability: 1/70, attendance: "present", avatar: null, studentId: 60, excluded: false},
        {name: "甲1", probability: 1/70, attendance: "present", avatar: null, studentId: 61, excluded: false},
        {name: "甲2", probability: 1/70, attendance: "present", avatar: null, studentId: 62, excluded: false},
        {name: "甲3", probability: 1/70, attendance: "present", avatar: null, studentId: 63, excluded: false},
        {name: "甲4", probability: 1/70, attendance: "present", avatar: null, studentId: 64, excluded: false},
        {name: "甲5", probability: 1/70, attendance: "present", avatar: null, studentId: 65, excluded: false},
        {name: "甲6", probability: 1/70, attendance: "present", avatar: null, studentId: 66, excluded: false},
        {name: "甲7", probability: 1/70, attendance: "present", avatar: null, studentId: 67, excluded: false},
        {name: "甲8", probability: 1/70, attendance: "present", avatar: null, studentId: 68, excluded: false},
        {name: "甲9", probability: 1/70, attendance: "present", avatar: null, studentId: 69, excluded: false},
        {name: "甲10", probability: 1/70, attendance: "present", avatar: null, studentId: 70, excluded: false}
    ];
    
    // 默认学生数据（用于恢复）
    const defaultStudents = JSON.parse(JSON.stringify(students));
    
    // 全局变量
    let selectedCount = 1;
    let isDrawing = false;
    let selectedStudents = []; // 手动选择的学生索引
    let excludedStudents = []; // 排除的学生索引
    let lastSelectedStudent = -1; // 上次被点到的学生索引
    let settings = {}; // 系统设置
    let drawnCount = 0; // 已抽取次数
    
    // 留言板相关变量
    let messages = []; // 存储所有消息
    let currentUser = null; // 当前用户
    let replyingTo = null; // 正在回复的消息
    let users = []; // 用户列表
    let imageSelectorCallback = null; // 图片选择回调函数
    let imageSelectorTarget = null; // 图片选择目标
    let selectedTextColor = "#333333"; // 默认文字颜色
    
    // 特殊学生特效设置
    let enableSpecialEffect = true;
    let specialEffectSettings = {
        26: { enableVideo: true, enableCelebration: true }, // 郭忠辉
        48: { enableVideo: true, enableCelebration: true }, // 一水大王（朱伍扬）
        15: { enableVideo: true, enableCelebration: true }  // 何发垚
    };
    
    // 特殊学生信息
    const specialStudents = {
        26: {
            name: "郭忠辉",
            avatar: "images/26.gif",
            video: "video/26.mp4",
            message: "恭喜抽出本班大神郭忠辉！他是班级的技术担当，编程高手，未来的计算机科学家！可惜染上了galgame"
        },
        48: {
            name: "一水大王（朱伍扬）",
            avatar: "images/48.gif",
            video: "video/48.mp4",
            message: "恭喜抽出本班大神一水大王！"
        },
        15: {
            name: "何发垚",
            avatar: "images/15.jpg",
            video: "video/15.mp4",
            message: "恭喜抽出本班大神何发垚！他是班级的学习委员，成绩优异，乐于助人，是大家学习的好榜样！"
        }
    };
    
    // 图片缓存
    let imageCache = {};
    
    // 公告相关变量
    let announcementText = "紧急通知网站崩了！";
    let announcementUpdateTimer = null;
    
    // 音效相关
    let soundEnabled = true;
    let currentSound = null;
    let windupSound = null; // 发条音效
    
    // DOM元素
    const menuToggle = document.getElementById('menuToggle');
    const closeMenu = document.getElementById('closeMenu');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const numberButtons = document.querySelectorAll('.number-btn');
    const resultDisplay = document.getElementById('resultDisplay');
    const resultTitle = document.getElementById('resultTitle');
    const totalStudents = document.getElementById('totalStudents');
    const totalStudentsMenu = document.getElementById('totalStudentsMenu');
    const excludedStudentsCount = document.getElementById('excludedStudentsCount');
    const probabilityModeStatus = document.getElementById('probabilityModeStatus');
    const soundEffectStatus = document.getElementById('soundEffectStatus');
    const excludeStudentListView = document.getElementById('excludeStudentListView');
    const excludedCountSpan = document.getElementById('excludedCount');
    const excludeAllBtn = document.getElementById('excludeAllBtn');
    const includeAllBtn = document.getElementById('includeAllBtn');
    const saveExcludedBtn = document.getElementById('saveExcludedBtn');
    const probabilityList = document.getElementById('probabilityList');
    const probabilitySum = document.getElementById('probabilitySum');
    const probabilityError = document.getElementById('probabilityError');
    const resetProbabilitiesBtn = document.getElementById('resetProbabilitiesBtn');
    const saveProbabilitiesBtn = document.getElementById('saveProbabilitiesBtn');
    const enableProbability = document.getElementById('enableProbability');
    const clickHint = document.getElementById('clickHint');
    const drawnCountElement = document.getElementById('drawnCount');
    const modeStatusElement = document.getElementById('modeStatus');
    const statusReadyElement = document.getElementById('statusReady');
    
    // 公告栏DOM元素
    const announcementTextElement = document.getElementById('announcementText');
    
    // 学生管理相关DOM元素
    const studentManagementSection = document.getElementById('studentManagementSection');
    const studentManagementList = document.getElementById('studentManagementList');
    const resetStudentNamesBtn = document.getElementById('resetStudentNamesBtn');
    const clearAllAvatarsBtn = document.getElementById('clearAllAvatarsBtn');
    const saveStudentManagementBtn = document.getElementById('saveStudentManagementBtn');
    
    // 留言板相关DOM元素
    const chatToggle = document.getElementById('chatToggle');
    const chatNotification = document.getElementById('chatNotification');
    const chatModal = document.getElementById('chatModal');
    const chatClose = document.getElementById('chatClose');
    const userList = document.getElementById('userList');
    const messagesContainer = document.getElementById('messagesContainer');
    const chatInput = document.getElementById('chatInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const imageUploadBtn = document.getElementById('imageUploadBtn');
    const selectImageBtn = document.getElementById('selectImageBtn');
    const chatImageInput = document.getElementById('chatImageInput');
    const chatUploadProgress = document.getElementById('chatUploadProgress');
    const chatUploadProgressFill = document.getElementById('chatUploadProgressFill');
    const replyPreview = document.getElementById('replyPreview');
    const replySenderName = document.getElementById('replySenderName');
    const replyPreviewText = document.getElementById('replyPreviewText');
    const cancelReply = document.getElementById('cancelReply');
    const openUserSettings = document.getElementById('openUserSettings');
    const openChatSettings = document.getElementById('openChatSettings');
    const userSettingsModal = document.getElementById('userSettingsModal');
    const chatSettingsModal = document.getElementById('chatSettingsModal');
    const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const cancelChatSettingsBtn = document.getElementById('cancelChatSettingsBtn');
    const saveChatSettingsBtn = document.getElementById('saveChatSettingsBtn');
    const userNameInput = document.getElementById('userNameInput');
    const avatarPreviewLarge = document.getElementById('avatarPreviewLarge');
    const currentAvatar = document.getElementById('currentAvatar');
    const uploadImageBtn = document.getElementById('uploadImageBtn');
    const selectFromImagesBtn = document.getElementById('selectFromImagesBtn');
    const avatarUploadInput = document.getElementById('avatarUploadInput');
    const imagePreviewModal = document.getElementById('imagePreviewModal');
    const previewedImage = document.getElementById('previewedImage');
    const closeImagePreview = document.getElementById('closeImagePreview');
    
    // 图片选择器相关DOM元素
    const imageSelectorModal = document.getElementById('imageSelectorModal');
    const imageSelectorClose = document.getElementById('imageSelectorClose');
    const imageSelectorContent = document.getElementById('imageSelectorContent');
    const cancelImageSelectBtn = document.getElementById('cancelImageSelectBtn');
    const confirmImageSelectBtn = document.getElementById('confirmImageSelectBtn');
    
    // 文字颜色选择器元素
    const colorOptions = document.querySelectorAll('.color-option');
    
    // 特殊学生特效DOM元素
    const specialEffectOverlay = document.getElementById('specialEffectOverlay');
    const videoContainer = document.getElementById('videoContainer');
    const specialVideo = document.getElementById('specialVideo');
    const skipVideoBtn = document.getElementById('skipVideoBtn');
    const celebrationContainer = document.getElementById('celebrationContainer');
    const celebrationCloseBtn = document.getElementById('celebrationCloseBtn');
    const celebrationAvatar = document.getElementById('celebrationAvatar');
    const celebrationName = document.getElementById('celebrationName');
    const celebrationMessage = document.getElementById('celebrationMessage');
    
    // 获取学生头像URL（优先GIF，然后JPG、PNG等）
    function getStudentAvatarUrl(studentId) {
        const student = students.find(s => s.studentId === studentId);
        if (!student) return null;
        
        // 如果学生有存储的base64头像，直接返回
        if (student.avatar && student.avatar.startsWith('data:image')) {
            return student.avatar;
        }
        
        // 如果学生有存储的URL头像，直接返回
        if (student.avatar && typeof student.avatar === 'string' && !student.avatar.startsWith('data:image')) {
            return student.avatar;
        }
        
        // 尝试从images文件夹加载默认头像，优先GIF
        const imageExtensions = ['gif', 'jpg', 'jpeg', 'png', 'webp', 'svg'];
        
        for (const ext of imageExtensions) {
            // 尝试序号文件名
            const pathByNumber = `images/${studentId}.${ext}`;
            
            // 尝试姓名文件名（替换空格为下划线）
            const studentNameForImage = student.name.replace(/\s+/g, '_');
            const pathByName = `images/${studentNameForImage}.${ext}`;
            
            // 这里我们只是返回路径，实际加载时检查文件是否存在
            return pathByNumber;
        }
        
        return null;
    }
    
    // 创建图片元素（优先显示GIF，然后是JPG、PNG等）- 优化版
    function createAvatarImg(studentId, studentName) {
        const student = students.find(s => s.studentId === studentId);
        const img = document.createElement('img');
        img.className = 'avatar';
        img.alt = studentName;
        
        // 如果有存储的base64头像，直接使用
        if (student.avatar && student.avatar.startsWith('data:image')) {
            img.src = student.avatar;
            return img;
        }
        
        // 如果有存储的URL头像，直接使用
        if (student.avatar && typeof student.avatar === 'string' && !student.avatar.startsWith('data:image')) {
            img.src = student.avatar;
            img.classList.add('avatar-loading');
            
            img.onerror = function() {
                this.classList.remove('avatar-loading');
                this.style.display = 'none';
                const avatarContainer = this.parentElement;
                if (avatarContainer) {
                    avatarContainer.innerHTML = '<div class="default-avatar"><i class="fas fa-user-graduate"></i></div>';
                }
            };
            
            img.onload = function() {
                this.classList.remove('avatar-loading');
            };
            
            return img;
        }
        
        // 否则尝试从images文件夹加载
        const avatarUrl = getStudentAvatarUrl(studentId);
        if (avatarUrl) {
            img.src = avatarUrl;
            img.classList.add('avatar-loading');
            
            img.onerror = function() {
                this.classList.remove('avatar-loading');
                
                // 如果是序号路径，尝试姓名路径
                const currentSrc = this.src;
                if (currentSrc.includes(`/${studentId}.`)) {
                    const studentNameForImage = student.name.replace(/\s+/g, '_');
                    const extensionMatch = currentSrc.match(/\.([a-zA-Z0-9]+)(?:$|\?)/);
                    
                    if (extensionMatch) {
                        const currentExt = extensionMatch[1].toLowerCase();
                        const extensions = ['gif', 'jpg', 'jpeg', 'png', 'webp', 'svg'];
                        const currentIndex = extensions.indexOf(currentExt);
                        
                        // 如果当前扩展名不是列表中的最后一个，尝试下一个扩展名
                        if (currentIndex >= 0 && currentIndex < extensions.length - 1) {
                            const nextExt = extensions[currentIndex + 1];
                            // 先尝试序号+下一个扩展名
                            const newSrcByNumber = currentSrc.replace(`.${currentExt}`, `.${nextExt}`);
                            this.src = newSrcByNumber;
                            this.classList.add('avatar-loading');
                            return;
                        }
                    }
                }
                
                // 如果所有扩展名都尝试过了，显示默认头像
                this.onerror = null;
                this.style.display = 'none';
                const avatarContainer = this.parentElement;
                if (avatarContainer) {
                    avatarContainer.innerHTML = '<div class="default-avatar"><i class="fas fa-user-graduate"></i></div>';
                }
            };
            
            img.onload = function() {
                this.classList.remove('avatar-loading');
            };
        } else {
            // 没有头像，显示默认图标
            img.style.display = 'none';
            const avatarContainer = document.createElement('div');
            avatarContainer.className = 'default-avatar';
            avatarContainer.innerHTML = '<i class="fas fa-user-graduate"></i>';
            return avatarContainer;
        }
        
        return img;
    }
    
    // 播放音效 - 在开始抽取时调用
    function playSoundEffect() {
        if (!soundEnabled) return;
        
        if (currentSound) {
            currentSound.pause();
            currentSound.currentTime = 0;
        }
        
        try {
            const soundType = document.getElementById('soundType').value;
            currentSound = new Audio();
            
            if (soundType === 'ding') {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 880;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
                currentSound = { pause: function() {}, currentTime: 0 };
            } else if (soundType === 'buzz') {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 440;
                oscillator.type = 'square';
                
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
                
                currentSound = { pause: function() {}, currentTime: 0 };
            } else if (soundType === 'windup') {
                // 发条音效 - 在开始抽取时播放
                currentSound.src = 'yinxiao/1.mp3';
                currentSound.volume = 0.4;
                currentSound.play();
            } else {
                // 默认点击音效
                currentSound.src = 'https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3';
                currentSound.volume = 0.3;
                currentSound.play();
            }
        } catch (e) {
            console.log("音效播放失败:", e);
        }
    }
    
    // 播放发条音效（3.5秒）- 现在在开始抽取时播放
    function playWindupSound() {
        if (!soundEnabled) return null;
        
        try {
            const audio = new Audio('yinxiao/1.mp3');
            audio.volume = 0.4;
            audio.loop = true;
            return audio;
        } catch (e) {
            console.log("发条音效播放失败:", e);
            return null;
        }
    }
    
    // 停止发条音效
    function stopWindupSound(audio) {
        if (audio) {
            audio.pause();
            audio.currentTime = 0;
        }
    }
    
    // 公告栏功能
    function initAnnouncement() {
        // 加载公告
        loadAnnouncement();
        
        // 设置公告更新定时器（每5分钟检查一次）
        announcementUpdateTimer = setInterval(loadAnnouncement, 1 * 1 * 1000);
        
        // 调整公告栏走马灯效果
        adjustAnnouncementScroll();
        
        // 监听窗口大小变化，调整公告栏
        window.addEventListener('resize', adjustAnnouncementScroll);
    }
    
    // 加载公告
    function loadAnnouncement() {
        // 这里使用GitHub Gist作为后端存储公告
        // 我们使用一个公开的Gist来存储公告内容
        const gistId = 'b77a2aacc7f39c9fd9fd38d353a7c977'; // 示例Gist ID，需要替换为实际的
        const gistUrl = `https://gist.githubusercontent.com/raw/${gistId}/announcement.txt`;
        
        // 使用fetch获取公告内容
        fetch(gistUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('无法获取公告');
                }
                return response.text();
            })
            .then(text => {
                // 更新公告内容
                announcementText = text.trim() || "紧急通知网站崩了！";
                updateAnnouncementDisplay();
            })
            .catch(error => {
                console.error('加载公告失败:', error);
                // 使用默认公告
                announcementText = "紧急通知网站崩了！";
                updateAnnouncementDisplay();
                
                // 尝试备用方案：从本地存储加载
                const savedAnnouncement = localStorage.getItem('announcement');
                if (savedAnnouncement) {
                    announcementText = savedAnnouncement;
                    updateAnnouncementDisplay();
                }
            });
    }
    
    // 更新公告显示
    function updateAnnouncementDisplay() {
        if (!announcementTextElement) return;
        
        // 更新公告内容
        announcementTextElement.textContent = announcementText;
        
        // 调整走马灯效果
        adjustAnnouncementScroll();
    }
    
    // 调整公告栏走马灯效果
    function adjustAnnouncementScroll() {
        if (!announcementTextElement) return;
        
        const announcementContainer = document.querySelector('.announcement-container');
        const announcementContent = document.querySelector('.announcement-content');
        
        if (!announcementContainer || !announcementContent) return;
        
        // 检查是否需要走马灯效果
        const containerWidth = announcementContainer.offsetWidth;
        const contentWidth = announcementTextElement.offsetWidth;
        const iconWidth = 30; // 图标宽度
        
        // 如果内容宽度大于容器宽度（减去图标宽度），则启用走马灯效果
        if (contentWidth > (containerWidth - iconWidth - 30)) {
            announcementTextElement.classList.add('announcement-scroll');
            announcementTextElement.style.animationDuration = `${Math.max(10, contentWidth / 30)}s`;
        } else {
            announcementTextElement.classList.remove('announcement-scroll');
        }
    }
    
    // 留言板功能
    
    // 初始化留言板
    function initChat() {
        // 从本地存储加载用户信息和消息
        loadChatData();
        
        // 如果当前用户不存在，设置默认用户
        if (!currentUser) {
            setDefaultUser();
        }
        
        // 加载用户列表
        loadUsers();
        
        // 加载消息
        loadMessages();
        
        // 加载文字颜色设置
        loadTextColorSetting();
        
        // 事件监听器
        chatToggle.addEventListener('click', openChat);
        chatClose.addEventListener('click', closeChat);
        sendMessageBtn.addEventListener('click', sendMessage);
        imageUploadBtn.addEventListener('click', () => chatImageInput.click());
        selectImageBtn.addEventListener('click', selectImageForChat);
        chatImageInput.addEventListener('change', handleChatImageUpload);
        cancelReply.addEventListener('click', cancelReplyToMessage);
        openUserSettings.addEventListener('click', openUserSettingsModal);
        openChatSettings.addEventListener('click', openChatSettingsModal);
        cancelSettingsBtn.addEventListener('click', closeUserSettingsModal);
        saveSettingsBtn.addEventListener('click', saveUserSettings);
        cancelChatSettingsBtn.addEventListener('click', closeChatSettingsModal);
        saveChatSettingsBtn.addEventListener('click', saveChatSettings);
        uploadImageBtn.addEventListener('click', () => avatarUploadInput.click());
        selectFromImagesBtn.addEventListener('click', selectImageFromImages);
        avatarUploadInput.addEventListener('change', handleAvatarUpload);
        avatarPreviewLarge.addEventListener('click', () => avatarUploadInput.click());
        closeImagePreview.addEventListener('click', closeImagePreviewModal);
        imageSelectorClose.addEventListener('click', closeImageSelector);
        cancelImageSelectBtn.addEventListener('click', closeImageSelector);
        confirmImageSelectBtn.addEventListener('click', confirmImageSelection);
        
        // 清空聊天记录按钮
        document.getElementById('clearChatHistoryBtn').addEventListener('click', clearChatHistory);
        
        // 文字颜色选择器事件
        colorOptions.forEach(option => {
            option.addEventListener('click', () => {
                colorOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                selectedTextColor = option.dataset.color;
                saveTextColorSetting();
            });
        });
        
        // 监听回车键发送消息
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // 更新用户设置弹窗中的头像
        updateUserSettingsPreview();
        
        // 预加载常用图片
        preloadImages();
    }
    
    // 预加载常用图片
    function preloadImages() {
        // 预加载1-10号学生头像
        for (let i = 1; i <= 10; i++) {
            const img = new Image();
            img.src = `images/${i}.gif`;
            imageCache[`images/${i}.gif`] = img;
        }
    }
    
    // 加载文字颜色设置
    function loadTextColorSetting() {
        const savedColor = localStorage.getItem('chatTextColor');
        if (savedColor) {
            selectedTextColor = savedColor;
            
            // 激活对应的颜色选项
            colorOptions.forEach(option => {
                if (option.dataset.color === savedColor) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
        }
    }
    
    // 保存文字颜色设置
    function saveTextColorSetting() {
        localStorage.setItem('chatTextColor', selectedTextColor);
    }
    
    // 设置默认用户
    function setDefaultUser() {
        currentUser = {
            id: generateUserId(),
            name: '匿名用户' + Math.floor(Math.random() * 1000),
            avatar: null,
            lastActive: new Date().toISOString()
        };
        
        saveCurrentUser();
    }
    
    // 生成用户ID
    function generateUserId() {
        return 'user_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
    }
    
    // 从本地存储加载聊天数据
    function loadChatData() {
        // 加载当前用户
        const savedUser = localStorage.getItem('chatCurrentUser');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
            } catch (e) {
                console.error("加载用户数据失败:", e);
            }
        }
        
        // 加载消息
        const savedMessages = localStorage.getItem('chatMessages');
        if (savedMessages) {
            try {
                messages = JSON.parse(savedMessages);
            } catch (e) {
                console.error("加载消息失败:", e);
            }
        }
        
        // 加载用户列表
        const savedUsers = localStorage.getItem('chatUsers');
        if (savedUsers) {
            try {
                users = JSON.parse(savedUsers);
            } catch (e) {
                console.error("加载用户列表失败:", e);
            }
        }
    }
    
    // 保存当前用户
    function saveCurrentUser() {
        if (currentUser) {
            // 更新最后活动时间
            currentUser.lastActive = new Date().toISOString();
            
            // 保存到本地存储
            localStorage.setItem('chatCurrentUser', JSON.stringify(currentUser));
            
            // 更新用户列表
            updateUserInList(currentUser);
        }
    }
    
    // 更新用户列表中的用户
    function updateUserInList(user) {
        const existingUserIndex = users.findIndex(u => u.id === user.id);
        
        if (existingUserIndex !== -1) {
            // 更新现有用户
            users[existingUserIndex] = user;
        } else {
            // 添加新用户
            users.push(user);
        }
        
        // 保存用户列表
        localStorage.setItem('chatUsers', JSON.stringify(users));
        
        // 更新UI
        loadUsers();
    }
    
    // 加载用户列表
    function loadUsers() {
        userList.innerHTML = '';
        
        // 添加当前用户
        if (currentUser) {
            const userItem = createUserItem(currentUser, true);
            userList.appendChild(userItem);
        }
        
        // 添加其他用户（按最后活动时间排序）
        const otherUsers = users
            .filter(user => !currentUser || user.id !== currentUser.id)
            .sort((a, b) => new Date(b.lastActive) - new Date(a.lastActive))
            .slice(0, 20); // 只显示最近活跃的20个用户
        
        otherUsers.forEach(user => {
            const userItem = createUserItem(user, false);
            userList.appendChild(userItem);
        });
    }
    
    // 创建用户列表项
    function createUserItem(user, isCurrentUser) {
        const userItem = document.createElement('div');
        userItem.className = 'user-item' + (isCurrentUser ? ' active' : '');
        userItem.dataset.userId = user.id;
        
        // 用户头像
        const userAvatar = document.createElement('div');
        userAvatar.className = 'user-avatar';
        
        if (user.avatar) {
            const img = document.createElement('img');
            img.src = user.avatar;
            img.alt = user.name;
            userAvatar.appendChild(img);
        } else {
            userAvatar.innerHTML = '<i class="fas fa-user" style="font-size: 1.2rem; color: #4a6fa5; display: flex; align-items: center; justify-content: center; height: 100%;"></i>';
        }
        
        // 用户信息
        const userInfo = document.createElement('div');
        userInfo.className = 'user-info';
        
        const userName = document.createElement('div');
        userName.className = 'user-name';
        userName.textContent = user.name + (isCurrentUser ? ' (我)' : '');
        
        const userStatus = document.createElement('div');
        userStatus.className = 'user-status';
        
        // 计算最后活动时间
        const lastActive = new Date(user.lastActive);
        const now = new Date();
        const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
        
        if (diffMinutes < 1) {
            userStatus.textContent = '刚刚在线';
            userStatus.style.color = '#2ecc71';
        } else if (diffMinutes < 5) {
            userStatus.textContent = `${diffMinutes}分钟前在线`;
            userStatus.style.color = '#f39c12';
        } else {
            userStatus.textContent = `${diffMinutes}分钟前在线`;
            userStatus.style.color = '#95a5a6';
        }
        
        userInfo.appendChild(userName);
        userInfo.appendChild(userStatus);
        
        userItem.appendChild(userAvatar);
        userItem.appendChild(userInfo);
        
        return userItem;
    }
    
    // 加载消息
    function loadMessages() {
        messagesContainer.innerHTML = '';
        
        // 添加欢迎消息
        const welcomeMessage = document.createElement('div');
        welcomeMessage.className = 'welcome-message';
        welcomeMessage.innerHTML = `
            <div class="message">
                <div class="message-avatar">
                    <i class="fas fa-robot" style="font-size: 1.5rem; color: #4a6fa5; display: flex; align-items: center; justify-content: center; height: 100%;"></i>
                    <div class="message-sender-name">系统消息</div>
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <div class="message-sender">系统消息</div>
                        <div class="message-time">刚刚</div>
                    </div>
                    <div class="message-text">
                        欢迎来到高三（1）班留言板！我是小钊，您可以在这里与同学们交流。
                    </div>
                </div>
            </div>
        `;
        messagesContainer.appendChild(welcomeMessage);
        
        // 添加所有消息
        messages.forEach(message => {
            const messageElement = createMessageElement(message);
            messagesContainer.appendChild(messageElement);
        });
        
        // 滚动到底部
        scrollToBottom();
    }
    
    // 创建消息元素
    function createMessageElement(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message message-optimized';
        messageDiv.dataset.messageId = message.id;
        
        // 判断是否是自己发送的消息
        const isOwnMessage = currentUser && message.senderId === currentUser.id;
        if (isOwnMessage) {
            messageDiv.classList.add('own');
        }
        
        // 用户头像
        const messageAvatar = document.createElement('div');
        messageAvatar.className = 'message-avatar';
        
        // 使用消息中存储的发送者信息，而不是从用户列表中查找
        // 这样可以保持消息发送时的状态
        const senderName = message.senderName || '未知用户';
        const senderAvatar = message.senderAvatar || null;
        
        if (senderAvatar) {
            const img = document.createElement('img');
            img.src = senderAvatar;
            img.alt = senderName;
            messageAvatar.appendChild(img);
        } else {
            messageAvatar.innerHTML = '<i class="fas fa-user" style="font-size: 1.2rem; color: #4a6fa5; display: flex; align-items: center; justify-content: center; height: 100%;"></i>';
        }
        
        // 发送者名字（在头像下方）
        const senderNameDiv = document.createElement('div');
        senderNameDiv.className = 'message-sender-name';
        senderNameDiv.textContent = senderName.length > 6 ? senderName.substring(0, 6) + '...' : senderName;
        messageAvatar.appendChild(senderNameDiv);
        
        // 消息内容
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        // 消息头部（发送者、时间）
        const messageHeader = document.createElement('div');
        messageHeader.className = 'message-header';
        
        const messageSender = document.createElement('div');
        messageSender.className = 'message-sender';
        messageSender.textContent = senderName;
        
        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        messageTime.textContent = formatMessageTime(message.timestamp);
        
        messageHeader.appendChild(messageSender);
        messageHeader.appendChild(messageTime);
        
        // 消息正文
        const messageText = document.createElement('div');
        messageText.className = 'message-text';
        
        // 应用消息中存储的文字颜色（如果有的话）
        if (message.textColor) {
            messageText.style.color = message.textColor;
        }
        
        // 如果是回复消息
        if (message.replyTo) {
            const repliedMessage = messages.find(m => m.id === message.replyTo);
            if (repliedMessage) {
                const repliedSenderName = repliedMessage.senderName || '未知用户';
                const replyText = document.createElement('div');
                replyText.style.fontSize = '0.85rem';
                replyText.style.color = isOwnMessage ? 'rgba(255,255,255,0.8)' : '#666';
                replyText.style.marginBottom = '5px';
                replyText.style.paddingLeft = '10px';
                replyText.style.borderLeft = `3px solid ${isOwnMessage ? 'rgba(255,255,255,0.5)' : '#4a6fa5'}`;
                
                let repliedText = repliedMessage.text;
                if (repliedText.length > 50) {
                    repliedText = repliedText.substring(0, 50) + '...';
                }
                
                replyText.innerHTML = `<strong>${repliedSenderName}:</strong> ${repliedText}`;
                messageText.appendChild(replyText);
            }
        }
        
        // 文本内容
        const textContent = document.createElement('div');
        textContent.textContent = message.text;
        messageText.appendChild(textContent);
        
        // 如果有图片
        if (message.image) {
            const messageImage = document.createElement('img');
            messageImage.className = 'message-image';
            messageImage.src = message.image;
            messageImage.alt = '消息图片';
            messageImage.addEventListener('click', () => previewImage(message.image));
            messageText.appendChild(messageImage);
        }
        
        // 消息操作（回复、删除）
        if (currentUser) {
            const messageActions = document.createElement('div');
            messageActions.className = 'message-actions';
            
            // 回复按钮
            const replyAction = document.createElement('span');
            replyAction.className = 'message-action';
            replyAction.innerHTML = '<i class="fas fa-reply"></i> 回复';
            replyAction.addEventListener('click', () => replyToMessage(message));
            messageActions.appendChild(replyAction);
            
            // 如果是自己发送的消息，显示删除按钮
            if (isOwnMessage) {
                const deleteAction = document.createElement('span');
                deleteAction.className = 'message-action';
                deleteAction.innerHTML = '<i class="fas fa-trash"></i> 删除';
                deleteAction.addEventListener('click', () => deleteMessage(message.id));
                messageActions.appendChild(deleteAction);
            }
            
            messageContent.appendChild(messageActions);
        }
        
        messageContent.appendChild(messageHeader);
        messageContent.appendChild(messageText);
        
        messageDiv.appendChild(messageAvatar);
        messageDiv.appendChild(messageContent);
        
        return messageDiv;
    }
    
    // 格式化消息时间
    function formatMessageTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        // 如果是一天内的消息
        if (diff < 24 * 60 * 60 * 1000) {
            // 如果是今天的消息
            if (date.getDate() === now.getDate()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                // 昨天的消息
                return '昨天 ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
        } else {
            // 更早的消息
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
    }
    
    // 发送消息
    function sendMessage() {
        const text = chatInput.value.trim();
        const image = null; // 这里可以添加图片上传功能
        
        if (!text && !image && !selectedChatImage) {
            return;
        }
        
        // 获取当前用户信息
        const senderName = currentUser.name;
        const senderAvatar = currentUser.avatar;
        
        // 创建消息对象
        const message = {
            id: generateMessageId(),
            senderId: currentUser.id,
            senderName: senderName, // 存储发送时的用户名
            senderAvatar: senderAvatar, // 存储发送时的头像
            text: text,
            textColor: selectedTextColor, // 存储发送时的文字颜色
            image: selectedChatImage || image,
            replyTo: replyingTo ? replyingTo.id : null,
            timestamp: new Date().toISOString()
        };
        
        // 添加到消息列表
        messages.push(message);
        
        // 保存消息
        localStorage.setItem('chatMessages', JSON.stringify(messages));
        
        // 清空输入框
        chatInput.value = '';
        
        // 清空选中的图片
        selectedChatImage = null;
        
        // 取消回复
        cancelReplyToMessage();
        
        // 添加消息到UI
        const messageElement = createMessageElement(message);
        messagesContainer.appendChild(messageElement);
        
        // 滚动到底部
        scrollToBottom();
        
        // 更新当前用户活动时间
        saveCurrentUser();
    }
    
    // 生成消息ID
    function generateMessageId() {
        return 'msg_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
    }
    
    // 回复消息
    function replyToMessage(message) {
        // 查找发送者
        const senderName = message.senderName || '未知用户';
        
        // 设置回复信息
        replyingTo = message;
        replySenderName.textContent = senderName;
        
        // 显示回复预览
        let replyText = message.text;
        if (replyText.length > 30) {
            replyText = replyText.substring(0, 30) + '...';
        }
        replyPreviewText.textContent = replyText;
        
        replyPreview.style.display = 'block';
        
        // 聚焦输入框
        chatInput.focus();
    }
    
    // 取消回复
    function cancelReplyToMessage() {
        replyingTo = null;
        replyPreview.style.display = 'none';
    }
    
    // 删除消息
    function deleteMessage(messageId) {
        if (!confirm('确定要删除这条消息吗？')) {
            return;
        }
        
        // 从消息列表中删除
        const messageIndex = messages.findIndex(m => m.id === messageId);
        if (messageIndex !== -1) {
            messages.splice(messageIndex, 1);
            
            // 保存更新后的消息列表
            localStorage.setItem('chatMessages', JSON.stringify(messages));
            
            // 从UI中删除
            const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.remove();
            }
        }
    }
    
    // 清空聊天记录
    function clearChatHistory() {
        if (!confirm('确定要清空所有聊天记录吗？此操作不可撤销！')) {
            return;
        }
        
        messages = [];
        localStorage.setItem('chatMessages', JSON.stringify(messages));
        
        // 重新加载消息
        loadMessages();
        
        alert('聊天记录已清空！');
    }
    
    // 打开留言板设置弹窗
    function openChatSettingsModal() {
        // 加载保存的设置
        loadChatSettings();
        
        // 打开弹窗
        chatSettingsModal.classList.add('active');
        overlay.classList.add('active');
    }
    
    // 关闭留言板设置弹窗
    function closeChatSettingsModal() {
        chatSettingsModal.classList.remove('active');
        overlay.classList.remove('active');
    }
    
    // 加载留言板设置
    function loadChatSettings() {
        const savedSettings = localStorage.getItem('chatSettings');
        if (savedSettings) {
            try {
                const settings = JSON.parse(savedSettings);
                document.getElementById('messageDisplayMode').value = settings.messageDisplayMode || 'normal';
                document.getElementById('messageTimeDisplay').value = settings.messageTimeDisplay || 'relative';
                document.getElementById('imageQuality').value = settings.imageQuality || 'medium';
                document.getElementById('messageNotification').value = settings.messageNotification || 'mentions';
            } catch (e) {
                console.error("加载留言板设置失败:", e);
            }
        }
    }
    
    // 保存留言板设置
    function saveChatSettings() {
        const settings = {
            messageDisplayMode: document.getElementById('messageDisplayMode').value,
            messageTimeDisplay: document.getElementById('messageTimeDisplay').value,
            imageQuality: document.getElementById('imageQuality').value,
            messageNotification: document.getElementById('messageNotification').value
        };
        
        localStorage.setItem('chatSettings', JSON.stringify(settings));
        
        closeChatSettingsModal();
        alert('留言板设置已保存！');
    }
    
    // 处理聊天图片上传
    let selectedChatImage = null;
    
    function handleChatImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // 检查文件类型
        const validTypes = ['image/gif', 'image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            alert('请选择有效的图片文件 (GIF, JPG, JPEG, PNG, WEBP)');
            return;
        }
        
        // 检查文件大小 (限制为5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('图片大小不能超过5MB');
            return;
        }
        
        // 显示上传进度
        chatUploadProgress.classList.add('active');
        chatUploadProgressFill.style.width = '0%';
        
        // 使用Web Worker优化图片处理（如果可用）
        if (window.Worker) {
            const worker = new Worker(URL.createObjectURL(
                new Blob([`
                    self.onmessage = function(e) {
                        const file = e.data;
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            self.postMessage(event.target.result);
                        };
                        reader.readAsDataURL(file);
                    };
                `], {type: 'application/javascript'})
            ));
            
            worker.onmessage = (e) => {
                const base64Image = e.data;
                
                // 将图片添加到消息输入框
                selectedChatImage = base64Image;
                chatInput.value = chatInput.value + '\n[图片]';
                
                // 隐藏上传进度
                chatUploadProgress.classList.remove('active');
                chatUploadProgressFill.style.width = '0%';
                
                // 聚焦输入框
                chatInput.focus();
                
                worker.terminate();
            };
            
            worker.postMessage(file);
            
            // 模拟上传进度
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                chatUploadProgressFill.style.width = progress + '%';
                
                if (progress >= 90) {
                    clearInterval(progressInterval);
                }
            }, 50);
        } else {
            // 降级方案：使用FileReader
            // 模拟上传进度
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                chatUploadProgressFill.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    
                    // 创建FileReader读取图片
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Image = e.target.result;
                        
                        // 将图片添加到消息输入框
                        selectedChatImage = base64Image;
                        chatInput.value = chatInput.value + '\n[图片]';
                        
                        // 隐藏上传进度
                        setTimeout(() => {
                            chatUploadProgress.classList.remove('active');
                        }, 500);
                        
                        // 聚焦输入框
                        chatInput.focus();
                    };
                    
                    reader.readAsDataURL(file);
                }
            }, 100);
        }
        
        // 重置文件输入
        event.target.value = '';
    }
    
    // 为聊天选择图片
    function selectImageForChat() {
        // 设置图片选择回调
        imageSelectorCallback = (imageSrc) => {
            if (imageSrc) {
                // 将图片添加到消息输入框
                selectedChatImage = imageSrc;
                chatInput.value = chatInput.value + '\n[图片]';
                
                // 聚焦输入框
                chatInput.focus();
                
                alert('图片已选择，可以发送消息了！');
            }
        };
        
        // 打开图片选择器
        openImageSelector();
    }
    
    // 预览图片
    function previewImage(imageSrc) {
        previewedImage.src = imageSrc;
        imagePreviewModal.classList.add('active');
        overlay.classList.add('active');
    }
    
    // 关闭图片预览
    function closeImagePreviewModal() {
        imagePreviewModal.classList.remove('active');
        overlay.classList.remove('active');
    }
    
    // 滚动到底部
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // 打开聊天窗口
    function openChat() {
        chatModal.classList.add('active');
        overlay.classList.add('active');
        
        // 聚焦输入框
        setTimeout(() => {
            chatInput.focus();
        }, 300);
        
        // 隐藏通知
        chatNotification.classList.add('hidden');
    }
    
    // 关闭聊天窗口
    function closeChat() {
        chatModal.classList.remove('active');
        overlay.classList.remove('active');
    }
    
    // 打开用户设置弹窗
    function openUserSettingsModal() {
        // 更新用户设置弹窗中的信息
        updateUserSettingsPreview();
        
        // 打开弹窗
        userSettingsModal.classList.add('active');
        overlay.classList.add('active');
    }
    
    // 关闭用户设置弹窗
    function closeUserSettingsModal() {
        userSettingsModal.classList.remove('active');
        overlay.classList.remove('active');
    }
    
    // 更新用户设置预览
    function updateUserSettingsPreview() {
        if (currentUser) {
            // 设置用户名
            userNameInput.value = currentUser.name;
            
            // 设置头像
            if (currentUser.avatar) {
                currentAvatar.src = currentUser.avatar;
                currentAvatar.style.display = 'block';
            } else {
                currentAvatar.src = '';
                currentAvatar.style.display = 'none';
            }
        }
    }
    
    // 保存用户设置
    function saveUserSettings() {
        const newName = userNameInput.value.trim();
        
        if (!newName) {
            alert('请输入用户名');
            return;
        }
        
        // 更新当前用户
        currentUser.name = newName;
        
        // 保存用户
        saveCurrentUser();
        
        // 关闭弹窗
        closeUserSettingsModal();
        
        // 重新加载用户列表
        loadUsers();
        
        alert('个人信息已更新！');
    }
    
    // 处理头像上传
    function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // 检查文件类型
        const validTypes = ['image/gif', 'image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            alert('请选择有效的图片文件 (GIF, JPG, JPEG, PNG, WEBP)');
            return;
        }
        
        // 使用requestAnimationFrame优化UI响应
        requestAnimationFrame(() => {
            const reader = new FileReader();
            reader.onload = (e) => {
                requestAnimationFrame(() => {
                    const base64Image = e.target.result;
                    
                    // 更新当前用户头像
                    currentUser.avatar = base64Image;
                    
                    // 更新预览
                    currentAvatar.src = base64Image;
                    currentAvatar.style.display = 'block';
                    
                    // 保存用户
                    saveCurrentUser();
                    
                    // 重新加载用户列表
                    loadUsers();
                });
            };
            
            reader.readAsDataURL(file);
        });
        
        // 重置文件输入
        event.target.value = '';
    }
    
    // 从images文件夹选择图片
    function selectImageFromImages() {
        // 设置图片选择回调
        imageSelectorCallback = (imageSrc) => {
            if (imageSrc) {
                // 更新当前用户头像
                currentUser.avatar = imageSrc;
                
                // 更新预览
                currentAvatar.src = imageSrc;
                currentAvatar.style.display = 'block';
                
                // 保存用户
                saveCurrentUser();
                
                // 重新加载用户列表
                loadUsers();
                
                alert('头像已更新！');
            }
        };
        
        // 打开图片选择器
        openImageSelector();
    }
    
    // 打开图片选择器 - 优化版
    function openImageSelector() {
        // 清空内容
        imageSelectorContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">正在加载图片...</div>';
        
        // 获取images文件夹中的图片
        getImagesFromImagesFolder().then(images => {
            // 使用requestAnimationFrame优化UI更新
            requestAnimationFrame(() => {
                imageSelectorContent.innerHTML = '';
                
                if (images.length === 0) {
                    imageSelectorContent.innerHTML = `
                        <div class="image-selector-empty">
                            <i class="fas fa-folder-open"></i>
                            <p>images文件夹中没有找到图片文件</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">请确保在images文件夹中有图片文件（支持GIF、JPG、JPEG、PNG、WEBP格式）</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">可以上传图片到images文件夹，或直接在系统中上传图片</p>
                        </div>
                    `;
                    return;
                }
                
                // 创建文档片段，批量添加DOM元素
                const fragment = document.createDocumentFragment();
                
                // 添加图片
                images.forEach((image, index) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-selector-item';
                    imageItem.dataset.index = index;
                    
                    const img = document.createElement('img');
                    img.className = 'image-thumbnail';
                    
                    // 使用缓存或加载图片
                    if (imageCache[image.url]) {
                        img.src = image.url;
                    } else {
                        img.src = image.url;
                        img.onload = () => {
                            // 缓存图片
                            imageCache[image.url] = img;
                        };
                    }
                    
                    img.alt = image.name;
                    
                    const filename = document.createElement('div');
                    filename.className = 'image-selector-filename';
                    filename.textContent = image.name;
                    
                    imageItem.appendChild(img);
                    imageItem.appendChild(filename);
                    
                    imageItem.addEventListener('click', () => {
                        // 移除所有选中状态
                        document.querySelectorAll('.image-selector-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // 添加选中状态
                        imageItem.classList.add('selected');
                    });
                    
                    fragment.appendChild(imageItem);
                });
                
                imageSelectorContent.appendChild(fragment);
                
                // 设置内容区域高度，确保可以滚动
                imageSelectorContent.style.maxHeight = 'calc(80vh - 150px)';
                imageSelectorContent.style.overflowY = 'auto';
            });
            
        }).catch(error => {
            console.error('加载图片失败:', error);
            imageSelectorContent.innerHTML = `
                <div class="image-selector-empty">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>无法加载images文件夹中的图片</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">${error.message || '请检查images文件夹是否存在'}</p>
                </div>
            `;
        });
        
        // 打开图片选择器
        imageSelectorModal.classList.add('active');
        overlay.classList.add('active');
    }
    
    // 获取images文件夹中的图片 - 优化版
    async function getImagesFromImagesFolder() {
        const images = [];
        const imageExtensions = ['gif', 'jpg', 'jpeg', 'png', 'webp'];
        
        // 批量检查图片，减少HTTP请求
        const checkPromises = [];
        
        // 尝试加载常见的学生头像（1-70）
        for (let i = 1; i <= 70; i++) {
            for (const ext of imageExtensions) {
                const url = `images/${i}.${ext}`;
                checkPromises.push(
                    checkImageExists(url).then(exists => {
                        if (exists) {
                            images.push({
                                name: `${i}.${ext}`,
                                url: url
                            });
                        }
                        return exists;
                    }).catch(() => false)
                );
                
                // 每10个图片检查一次，避免同时发起过多请求
                if (checkPromises.length % 10 === 0) {
                    await Promise.all(checkPromises);
                }
            }
        }
        
        await Promise.all(checkPromises);
        
        // 如果没找到序号图片，尝试加载其他常见图片
        if (images.length === 0) {
            const commonNames = ['default', 'avatar', 'user', 'profile', 'photo'];
            for (const name of commonNames) {
                for (const ext of imageExtensions) {
                    const url = `images/${name}.${ext}`;
                    try {
                        const exists = await checkImageExists(url);
                        if (exists) {
                            images.push({
                                name: `${name}.${ext}`,
                                url: url
                            });
                            break;
                        }
                    } catch (error) {
                        console.error(`检查图片 ${url} 失败:`, error);
                    }
                }
            }
        }
        
        return images;
    }
    
    // 检查图片是否存在 - 优化版
    function checkImageExists(url) {
        return new Promise((resolve) => {
            // 如果已经在缓存中，直接返回
            if (imageCache[url]) {
                resolve(true);
                return;
            }
            
            const img = new Image();
            img.onload = () => {
                imageCache[url] = img;
                resolve(true);
            };
            img.onerror = () => resolve(false);
            img.src = url;
            
            // 设置超时，避免长时间等待
            setTimeout(() => resolve(false), 500);
        });
    }
    
    // 关闭图片选择器
    function closeImageSelector() {
        imageSelectorModal.classList.remove('active');
        overlay.classList.remove('active');
    }
    
    // 确认图片选择
    function confirmImageSelection() {
        const selectedItem = document.querySelector('.image-selector-item.selected');
        if (!selectedItem) {
            alert('请先选择一张图片');
            return;
        }
        
        const index = parseInt(selectedItem.dataset.index);
        const img = selectedItem.querySelector('img');
        
        if (img && img.src && imageSelectorCallback) {
            imageSelectorCallback(img.src);
        }
        
        closeImageSelector();
    }
    
    // 特殊学生特效功能
    
    // 初始化特殊学生特效
    function initSpecialEffect() {
        // 加载设置
        loadSpecialEffectSettings();
        
        // 事件监听
        skipVideoBtn.addEventListener('click', skipVideo);
        celebrationCloseBtn.addEventListener('click', closeSpecialEffect);
        specialVideo.addEventListener('ended', showCelebration);
        
        // 特效设置事件监听
        document.getElementById('saveSpecialEffectSettings').addEventListener('click', saveSpecialEffectSettings);
        
        // 特殊学生设置事件监听
        document.querySelectorAll('.student-video-effect').forEach(checkbox => {
            checkbox.addEventListener('change', updateSpecialEffectSettings);
        });
        
        document.querySelectorAll('.student-celebration-effect').forEach(checkbox => {
            checkbox.addEventListener('change', updateSpecialEffectSettings);
        });
        
        document.getElementById('enableSpecialEffect').addEventListener('change', updateSpecialEffectSettings);
    }
    
    // 加载特效设置
    function loadSpecialEffectSettings() {
        const savedSettings = localStorage.getItem('specialEffectSettings');
        if (savedSettings) {
            try {
                const settings = JSON.parse(savedSettings);
                enableSpecialEffect = settings.enableSpecialEffect !== false;
                
                // 加载特殊学生设置
                if (settings.specialEffectSettings) {
                    specialEffectSettings = settings.specialEffectSettings;
                }
                
                // 加载音量设置
                if (settings.effectVolume !== undefined) {
                    document.getElementById('effectVolume').value = settings.effectVolume;
                }
                
                // 更新UI
                document.getElementById('enableSpecialEffect').checked = enableSpecialEffect;
                
                // 更新每个学生的设置
                for (const studentId in specialEffectSettings) {
                    const videoCheckbox = document.querySelector(`.student-video-effect[data-student-id="${studentId}"]`);
                    const celebrationCheckbox = document.querySelector(`.student-celebration-effect[data-student-id="${studentId}"]`);
                    
                    if (videoCheckbox) {
                        videoCheckbox.checked = specialEffectSettings[studentId].enableVideo !== false;
                    }
                    
                    if (celebrationCheckbox) {
                        celebrationCheckbox.checked = specialEffectSettings[studentId].enableCelebration !== false;
                    }
                }
            } catch (e) {
                console.error("加载特效设置失败:", e);
            }
        }
    }
    
    // 更新特殊学生设置
    function updateSpecialEffectSettings() {
        enableSpecialEffect = document.getElementById('enableSpecialEffect').checked;
        
        // 更新每个学生的设置
        document.querySelectorAll('.student-video-effect').forEach(checkbox => {
            const studentId = checkbox.dataset.studentId;
            if (!specialEffectSettings[studentId]) {
                specialEffectSettings[studentId] = { enableVideo: true, enableCelebration: true };
            }
            specialEffectSettings[studentId].enableVideo = checkbox.checked;
        });
        
        document.querySelectorAll('.student-celebration-effect').forEach(checkbox => {
            const studentId = checkbox.dataset.studentId;
            if (!specialEffectSettings[studentId]) {
                specialEffectSettings[studentId] = { enableVideo: true, enableCelebration: true };
            }
            specialEffectSettings[studentId].enableCelebration = checkbox.checked;
        });
    }
    
    // 保存特效设置
    function saveSpecialEffectSettings() {
        updateSpecialEffectSettings();
        
        const settings = {
            enableSpecialEffect: enableSpecialEffect,
            specialEffectSettings: specialEffectSettings,
            effectVolume: document.getElementById('effectVolume').value
        };
        
        localStorage.setItem('specialEffectSettings', JSON.stringify(settings));
        
        alert('特效设置已保存！');
    }
    
    // 显示特殊学生特效
    function showSpecialEffect(studentId) {
        if (!enableSpecialEffect || !specialEffectSettings[studentId]) {
            return;
        }
        
        const studentSettings = specialEffectSettings[studentId];
        const studentInfo = specialStudents[studentId];
        
        if (!studentInfo) {
            return;
        }
        
        specialEffectOverlay.classList.add('active');
        
        // 设置视频音量
        const volume = document.getElementById('effectVolume').value / 100;
        specialVideo.volume = volume;
        
        // 设置视频源
        specialVideo.src = studentInfo.video;
        
        // 设置庆祝画面内容
        celebrationAvatar.src = studentInfo.avatar;
        celebrationName.textContent = studentInfo.name;
        celebrationMessage.textContent = studentInfo.message;
        
        if (studentSettings.enableVideo) {
            videoContainer.style.display = 'block';
            celebrationContainer.style.display = 'none';
            specialVideo.play().catch(e => {
                console.error("视频播放失败:", e);
                // 如果视频播放失败，直接显示庆祝画面
                if (studentSettings.enableCelebration) {
                    showCelebration();
                } else {
                    closeSpecialEffect();
                }
            });
        } else if (studentSettings.enableCelebration) {
            videoContainer.style.display = 'none';
            celebrationContainer.style.display = 'flex';
            celebrationContainer.classList.add('active');
        } else {
            closeSpecialEffect();
        }
    }
    
    // 跳过视频
    function skipVideo() {
        specialVideo.pause();
        
        // 获取当前学生的ID
        const studentId = Object.keys(specialStudents).find(id => 
            specialStudents[id].video === specialVideo.src || 
            specialStudents[id].video === specialVideo.currentSrc
        );
        
        if (studentId && specialEffectSettings[studentId] && specialEffectSettings[studentId].enableCelebration) {
            showCelebration();
        } else {
            closeSpecialEffect();
        }
    }
    
    // 显示庆祝画面
    function showCelebration() {
        videoContainer.style.display = 'none';
        celebrationContainer.style.display = 'flex';
        celebrationContainer.classList.add('active');
    }
    
    // 关闭特效
    function closeSpecialEffect() {
        specialVideo.pause();
        specialVideo.currentTime = 0;
        specialEffectOverlay.classList.remove('active');
        videoContainer.style.display = 'block';
        celebrationContainer.style.display = 'none';
        celebrationContainer.classList.remove('active');
    }
    
    // 检查是否抽到特殊学生
    function checkSpecialEffect(selectedIndices) {
        if (!enableSpecialEffect) return false;
        
        for (const index of selectedIndices) {
            const studentId = students[index].studentId;
            
            if (specialStudents[studentId]) {
                // 延迟显示特效，让点名结果先显示
                setTimeout(() => {
                    showSpecialEffect(studentId);
                }, 1000);
                return true;
            }
        }
        return false;
    }
    
    // 初始化
    function init() {
        // 尝试从本地存储加载数据
        loadFromLocalStorage();
        
        // 更新学生总数显示
        totalStudents.textContent = students.length;
        totalStudentsMenu.textContent = students.length;
        
        // 生成学生列表
        generateExcludeStudentList();
        
        // 更新排除学生计数
        updateExcludedCount();
        
        // 事件监听器
        menuToggle.addEventListener('click', () => {
            sidebar.classList.add('active');
            overlay.classList.add('active');
        });
        
        closeMenu.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });
        
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            chatModal.classList.remove('active');
            userSettingsModal.classList.remove('active');
            chatSettingsModal.classList.remove('active');
            imagePreviewModal.classList.remove('active');
            imageSelectorModal.classList.remove('active');
        });
        
        // 选择人数按钮
        numberButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                numberButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedCount = parseInt(btn.dataset.count);
            });
        });
        
        // 开始点名按钮
        startBtn.addEventListener('click', startDrawing);
        
        // 排除学生按钮
        excludeAllBtn.addEventListener('click', excludeAllStudents);
        includeAllBtn.addEventListener('click', includeAllStudents);
        saveExcludedBtn.addEventListener('click', saveExcludedStudents);
        
        // 学生管理按钮
        resetStudentNamesBtn.addEventListener('click', resetStudentNames);
        clearAllAvatarsBtn.addEventListener('click', clearAllAvatars);
        saveStudentManagementBtn.addEventListener('click', saveStudentManagement);
        
        // 概率设置
        resetProbabilitiesBtn.addEventListener('click', resetProbabilities);
        saveProbabilitiesBtn.addEventListener('click', saveProbabilities);
        enableProbability.addEventListener('change', toggleProbabilityMode);
        
        // 初始显示
        resultTitle.innerHTML = `<i class="fas fa-user-graduate"></i> 等待点名...`;
        resultDisplay.innerHTML = `
            <div class="placeholder-card">
                <i class="fas fa-users"></i>
                <p style="font-size: 1.1rem;">点击"开始点名"按钮开始抽取</p>
                <p style="font-size: 0.85rem; color: #888; margin-top: 8px;">2025.12.15</p>
            </div>
        `;
        
        // 初始化设置
        initSettings();
        
        // 更新概率模式状态
        updateProbabilityModeStatus();
        
        // 更新音效状态
        updateSoundEffectStatus();
        
        // 隐藏点击提示
        setTimeout(() => {
            clickHint.style.opacity = '0';
            setTimeout(() => {
                clickHint.style.display = 'none';
            }, 1000);
        }, 5000);
        
        // 更新抽取信息
        updateDrawInfo();
        
        // 初始化留言板
        initChat();
        
        // 初始化特殊学生特效
        initSpecialEffect();
        
        // 生成概率设置列表
        generateProbabilityList();
        
        // 初始化公告栏
        initAnnouncement();
        
        // 优化：使用事件委托减少事件监听器
        setupEventDelegation();
        
        // 优化：使用requestAnimationFrame优化动画
        optimizeAnimations();
        
        // 直接显示学生管理部分（无需密码）
        studentManagementSection.style.display = 'block';
        generateStudentManagementList();
    }
    
    // 设置事件委托
    function setupEventDelegation() {
        // 使用事件委托处理学生卡片点击
        document.addEventListener('click', (e) => {
            // 处理学生卡片点击
            if (e.target.closest('.student-card')) {
                const card = e.target.closest('.student-card');
                // 可以在这里添加学生卡片的点击处理
            }
        });
    }
    
    // 优化动画
    function optimizeAnimations() {
        // 使用will-change属性优化动画性能
        const elementsToOptimize = document.querySelectorAll('.student-card, .message, .start-btn');
        elementsToOptimize.forEach(el => {
            el.style.willChange = 'transform, opacity';
        });
    }
    
    // 生成学生管理列表
    function generateStudentManagementList() {
        studentManagementList.innerHTML = '';
        
        // 使用文档片段优化DOM操作
        const fragment = document.createDocumentFragment();
        
        for (let i = 0; i < students.length; i++) {
            const student = students[i];
            const managementItem = document.createElement('div');
            managementItem.className = 'student-management-item';
            managementItem.dataset.studentId = student.studentId;
            
            const avatarContainer = document.createElement('div');
            avatarContainer.className = 'student-management-avatar';
            
            if (student.avatar && student.avatar.startsWith('data:image')) {
                const img = document.createElement('img');
                img.src = student.avatar;
                img.alt = student.name;
                avatarContainer.appendChild(img);
            } else if (student.avatar && typeof student.avatar === 'string' && !student.avatar.startsWith('data:image')) {
                const img = document.createElement('img');
                img.src = student.avatar;
                img.alt = student.name;
                avatarContainer.appendChild(img);
            } else {
                avatarContainer.innerHTML = '<i class="fas fa-user-graduate"></i>';
            }
            
            const infoContainer = document.createElement('div');
            infoContainer.className = 'student-management-info';
            
            const numberSpan = document.createElement('div');
            numberSpan.className = 'student-management-number';
            numberSpan.textContent = `第${student.studentId}号`;
            
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.className = 'student-management-name-input';
            nameInput.value = student.name;
            nameInput.dataset.studentId = student.studentId;
            
            nameInput.addEventListener('input', (e) => {
                const studentId = parseInt(e.target.dataset.studentId);
                const newName = e.target.value.trim();
                const student = students.find(s => s.studentId === studentId);
                if (student) {
                    student.name = newName || `学生${studentId}`;
                }
            });
            
            infoContainer.appendChild(numberSpan);
            infoContainer.appendChild(nameInput);
            
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'student-management-actions';
            
            const uploadBtn = document.createElement('div');
            uploadBtn.className = 'student-management-upload-btn';
            uploadBtn.textContent = '上传头像';
            uploadBtn.dataset.studentId = student.studentId;
            
            uploadBtn.addEventListener('click', (e) => {
                const studentId = parseInt(e.target.dataset.studentId);
                uploadAvatarForStudent(studentId);
            });
            
            const selectBtn = document.createElement('div');
            selectBtn.className = 'student-management-upload-btn';
            selectBtn.textContent = '从images选择';
            selectBtn.dataset.studentId = student.studentId;
            
            selectBtn.addEventListener('click', (e) => {
                const studentId = parseInt(e.target.dataset.studentId);
                selectImageFromImagesForStudent(studentId);
            });
            
            const removeBtn = document.createElement('div');
            removeBtn.className = 'student-management-remove-btn';
            removeBtn.textContent = '移除头像';
            removeBtn.dataset.studentId = student.studentId;
            
            removeBtn.addEventListener('click', (e) => {
                const studentId = parseInt(e.target.dataset.studentId);
                removeAvatarForStudent(studentId);
            });
            
            actionsContainer.appendChild(uploadBtn);
            actionsContainer.appendChild(selectBtn);
            actionsContainer.appendChild(removeBtn);
            
            managementItem.appendChild(avatarContainer);
            managementItem.appendChild(infoContainer);
            managementItem.appendChild(actionsContainer);
            
            fragment.appendChild(managementItem);
        }
        
        studentManagementList.appendChild(fragment);
    }
    
    // 上传学生头像
    function uploadAvatarForStudent(studentId) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/gif,image/jpeg,image/jpg,image/png,image/webp';
        input.style.display = 'none';
        
        input.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // 检查文件类型
            const validTypes = ['image/gif', 'image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('请选择有效的图片文件 (GIF, JPG, JPEG, PNG, WEBP)');
                return;
            }
            
            // 检查文件大小 (限制为2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('图片大小不能超过2MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const base64Image = event.target.result;
                
                // 更新学生数据
                const student = students.find(s => s.studentId === studentId);
                if (student) {
                    student.avatar = base64Image;
                    
                    // 更新UI
                    const managementItem = document.querySelector(`.student-management-item[data-student-id="${studentId}"]`);
                    if (managementItem) {
                        const avatarContainer = managementItem.querySelector('.student-management-avatar');
                        avatarContainer.innerHTML = '';
                        const img = document.createElement('img');
                        img.src = base64Image;
                        img.alt = student.name;
                        avatarContainer.appendChild(img);
                    }
                    
                    // 保存到本地存储
                    saveStudents();
                    
                    alert('头像上传成功！');
                }
            };
            
            reader.readAsDataURL(file);
        });
        
        document.body.appendChild(input);
        input.click();
        document.body.removeChild(input);
    }
    
    // 为学生从images选择图片
    function selectImageFromImagesForStudent(studentId) {
        imageSelectorTarget = studentId;
        
        // 设置图片选择回调
        imageSelectorCallback = (imageSrc) => {
            if (imageSrc) {
                // 更新学生数据
                const student = students.find(s => s.studentId === imageSelectorTarget);
                if (student) {
                    student.avatar = imageSrc;
                    
                    // 更新UI
                    const managementItem = document.querySelector(`.student-management-item[data-student-id="${imageSelectorTarget}"]`);
                    if (managementItem) {
                        const avatarContainer = managementItem.querySelector('.student-management-avatar');
                        avatarContainer.innerHTML = '';
                        const img = document.createElement('img');
                        img.src = imageSrc;
                        img.alt = student.name;
                        avatarContainer.appendChild(img);
                    }
                    
                    // 保存到本地存储
                    saveStudents();
                    
                    alert('头像设置成功！');
                }
            }
        };
        
        // 打开图片选择器
        openImageSelector();
    }
    
    // 移除学生头像
    function removeAvatarForStudent(studentId) {
        if (!confirm('确定要移除该学生的头像吗？')) {
            return;
        }
        
        const student = students.find(s => s.studentId === studentId);
        if (student) {
            student.avatar = null;
            
            // 更新UI
            const managementItem = document.querySelector(`.student-management-item[data-student-id="${studentId}"]`);
            if (managementItem) {
                const avatarContainer = managementItem.querySelector('.student-management-avatar');
                avatarContainer.innerHTML = '<i class="fas fa-user-graduate"></i>';
            }
            
            // 保存到本地存储
            saveStudents();
            
            alert('头像已移除！');
        }
    }
    
    // 重置学生姓名
    function resetStudentNames() {
        if (!confirm('确定要恢复所有学生的默认姓名吗？这将覆盖所有修改过的姓名。')) {
            return;
        }
        
        for (let i = 0; i < students.length; i++) {
            const defaultStudent = defaultStudents.find(s => s.studentId === students[i].studentId);
            if (defaultStudent) {
                students[i].name = defaultStudent.name;
            }
        }
        
        // 更新UI
        generateStudentManagementList();
        
        // 保存到本地存储
        saveStudents();
        
        alert('学生姓名已恢复为默认值！');
    }
    
    // 清除所有头像
    function clearAllAvatars() {
        if (!confirm('确定要清除所有学生的头像吗？这将删除所有上传的头像。')) {
            return;
        }
        
        for (let i = 0; i < students.length; i++) {
            students[i].avatar = null;
        }
        
        // 更新UI
        generateStudentManagementList();
        
        // 保存到本地存储
        saveStudents();
        
        alert('所有头像已清除！');
    }
    
    // 保存学生管理修改
    function saveStudentManagement() {
        saveStudents();
        alert('学生信息已保存！');
    }
    
    // 从本地存储加载数据
    function loadFromLocalStorage() {
        // 加载学生数据
        const savedStudents = localStorage.getItem('classRollerStudents');
        if (savedStudents) {
            try {
                const parsedStudents = JSON.parse(savedStudents);
                
                for (let i = 0; i < students.length; i++) {
                    const savedStudent = parsedStudents.find(s => s.studentId === students[i].studentId);
                    if (savedStudent) {
                        students[i].name = savedStudent.name || students[i].name;
                        students[i].avatar = savedStudent.avatar || null;
                        if (savedStudent.probability !== undefined) {
                            students[i].probability = savedStudent.probability;
                        }
                        if (savedStudent.excluded !== undefined) {
                            students[i].excluded = savedStudent.excluded;
                        }
                    }
                }
            } catch (e) {
                console.error("加载学生数据失败:", e);
            }
        }
        
        // 加载设置
        const savedSettings = localStorage.getItem('classRollerSettings');
        if (savedSettings) {
            try {
                settings = JSON.parse(savedSettings);
            } catch (e) {
                console.error("加载设置失败:", e);
            }
        }
        
        // 加载排除学生列表
        const savedExcluded = localStorage.getItem('classRollerExcluded');
        if (savedExcluded) {
            try {
                excludedStudents = JSON.parse(savedExcluded);
            } catch (e) {
                console.error("加载排除学生列表失败:", e);
            }
        }
        
        // 加载抽取次数
        const savedDrawnCount = localStorage.getItem('classRollerDrawnCount');
        if (savedDrawnCount) {
            drawnCount = parseInt(savedDrawnCount) || 0;
        }
    }
    
    // 生成排除学生列表
    function generateExcludeStudentList() {
        excludeStudentListView.innerHTML = '';
        
        // 使用文档片段优化
        const fragment = document.createDocumentFragment();
        
        for (let i = 0; i < students.length; i++) {
            const listItem = document.createElement('div');
            listItem.className = 'student-list-item';
            if (students[i].excluded) {
                listItem.classList.add('excluded');
            }
            listItem.dataset.index = i;
            
            listItem.innerHTML = `
                <div class="student-info">
                    <span class="student-number">${students[i].studentId}</span>
                    <span class="student-name">${students[i].name}</span>
                </div>
                <div>
                    <input type="checkbox" class="exclude-checkbox" ${students[i].excluded ? 'checked' : ''}>
                </div>
            `;
            
            listItem.addEventListener('click', (e) => {
                if (e.target.type === 'checkbox') return;
                
                const index = parseInt(listItem.dataset.index);
                toggleExcludeStudent(index);
            });
            
            const checkbox = listItem.querySelector('.exclude-checkbox');
            checkbox.addEventListener('click', (e) => {
                e.stopPropagation();
                const index = parseInt(listItem.dataset.index);
                toggleExcludeStudent(index);
            });
            
            fragment.appendChild(listItem);
        }
        
        excludeStudentListView.appendChild(fragment);
        updateExcludedCount();
    }
    
    // 生成概率设置列表
    function generateProbabilityList() {
        probabilityList.innerHTML = '';
        
        // 使用文档片段优化
        const fragment = document.createDocumentFragment();
        
        for (let i = 0; i < students.length; i++) {
            const probabilityItem = document.createElement('div');
            probabilityItem.className = 'probability-item';
            
            const probabilityValue = students[i].probability;
            const displayValue = probabilityValue.toFixed(4);
            
            probabilityItem.innerHTML = `
                <div class="student-info">
                    <span class="student-number">${students[i].studentId}</span>
                    <span class="student-name">${students[i].name}</span>
                </div>
                <div>
                    <input type="number" class="probability-input" value="${displayValue}" step="0.0001" min="0" max="1" data-id="${students[i].studentId}">
                    <div class="probability-display">${(probabilityValue * 100).toFixed(2)}%</div>
                </div>
            `;
            
            const probabilityInput = probabilityItem.querySelector('.probability-input');
            probabilityInput.addEventListener('input', (e) => {
                const studentId = parseInt(e.target.dataset.id);
                const newValue = parseFloat(e.target.value) || 0;
                
                const student = students.find(s => s.studentId === studentId);
                if (student) {
                    student.probability = newValue;
                    
                    const displayElement = probabilityItem.querySelector('.probability-display');
                    displayElement.textContent = `${(newValue * 100).toFixed(2)}%`;
                    
                    updateProbabilitySum();
                }
            });
            
            fragment.appendChild(probabilityItem);
        }
        
        probabilityList.appendChild(fragment);
        updateProbabilitySum();
    }
    
    // 更新概率总和显示
    function updateProbabilitySum() {
        let sum = 0;
        for (let i = 0; i < students.length; i++) {
            sum += students[i].probability;
        }
        
        probabilitySum.textContent = sum.toFixed(4);
        
        if (Math.abs(sum - 1.0) > 0.0001) {
            probabilityError.style.display = 'block';
            saveProbabilitiesBtn.disabled = true;
            saveProbabilitiesBtn.style.opacity = '0.6';
        } else {
            probabilityError.style.display = 'none';
            saveProbabilitiesBtn.disabled = false;
            saveProbabilitiesBtn.style.opacity = '1';
        }
    }
    
    // 重置概率为平均分配
    function resetProbabilities() {
        const avgProbability = 1 / students.length;
        
        for (let i = 0; i < students.length; i++) {
            students[i].probability = avgProbability;
        }
        
        generateProbabilityList();
        saveStudents();
    }
    
    // 保存概率设置
    function saveProbabilities() {
        let sum = 0;
        for (let i = 0; i < students.length; i++) {
            sum += students[i].probability;
        }
        
        if (Math.abs(sum - 1.0) > 0.0001) {
            alert('概率总和必须为1！当前总和为' + sum.toFixed(4));
            return;
        }
        
        saveStudents();
        alert('概率设置已保存！');
    }
    
    // 切换概率模式
    function toggleProbabilityMode() {
        const enabled = enableProbability.checked;
        settings.enableProbability = enabled;
        saveSettings();
        updateProbabilityModeStatus();
        
        if (enabled) {
            alert('概率点名模式已启用，将按照设置的概率进行随机抽取。');
        } else {
            alert('概率点名模式已禁用，将使用平均概率进行随机抽取。');
        }
    }
    
    // 更新概率模式状态显示
    function updateProbabilityModeStatus() {
        const enabled = settings.enableProbability !== false;
        probabilityModeStatus.textContent = enabled ? '已启用' : '已禁用';
        probabilityModeStatus.style.color = enabled ? '#27ae60' : '#e74c3c';
        
        if (enableProbability) {
            enableProbability.checked = enabled;
        }
    }
    
    // 切换音效
    function toggleSoundEffect() {
        soundEnabled = document.getElementById('enableSound').checked;
        settings.enableSound = soundEnabled;
        saveSettings();
        updateSoundEffectStatus();
        
        if (soundEnabled) {
            playSoundEffect();
        }
    }
    
    // 更新音效状态显示
    function updateSoundEffectStatus() {
        const enabled = settings.enableSound !== false;
        soundEffectStatus.textContent = enabled ? '已启用' : '已禁用';
        soundEffectStatus.style.color = enabled ? '#27ae60' : '#e74c3c';
        
        const enableSoundCheckbox = document.getElementById('enableSound');
        if (enableSoundCheckbox) {
            enableSoundCheckbox.checked = enabled;
        }
        
        soundEnabled = enabled;
    }
    
    // 保存音效设置
    function saveSoundSettings() {
        settings.soundType = document.getElementById('soundType').value;
        saveSettings();
    }
    
    // 切换排除学生状态
    function toggleExcludeStudent(index) {
        const student = students[index];
        student.excluded = !student.excluded;
        
        const listItem = document.querySelector(`.student-list-item[data-index="${index}"]`);
        if (student.excluded) {
            listItem.classList.add('excluded');
        } else {
            listItem.classList.remove('excluded');
        }
        
        const checkbox = listItem.querySelector('.exclude-checkbox');
        checkbox.checked = student.excluded;
        
        updateExcludedCount();
    }
    
    // 更新排除学生计数
    function updateExcludedCount() {
        let excludedCount = 0;
        for (let i = 0; i < students.length; i++) {
            if (students[i].excluded) {
                excludedCount++;
            }
        }
        
        excludedCountSpan.textContent = excludedCount;
        excludedStudentsCount.textContent = excludedCount;
    }
    
    // 排除所有学生
    function excludeAllStudents() {
        for (let i = 0; i < students.length; i++) {
            students[i].excluded = true;
        }
        generateExcludeStudentList();
    }
    
    // 包含所有学生（取消排除）
    function includeAllStudents() {
        for (let i = 0; i < students.length; i++) {
            students[i].excluded = false;
        }
        generateExcludeStudentList();
    }
    
    // 保存排除学生设置
    function saveExcludedStudents() {
        saveStudents();
        alert('排除学生设置已保存！');
    }
    
    // 保存学生数据到本地存储
    function saveStudents() {
        localStorage.setItem('classRollerStudents', JSON.stringify(students));
    }
    
    // 保存设置到本地存储
    function saveSettings() {
        localStorage.setItem('classRollerSettings', JSON.stringify(settings));
    }
    
    // 初始化设置
    function initSettings() {
        const defaultSettings = {
            rollMode: 'random',
            preventRepeat: true,
            excludeAbsent: true,
            excludeManual: true,
            enableAnimation: true,
            animationSpeed: 'normal',
            highlightEffect: 'pulse',
            theme: 'blue',
            repeatInterval: 5,
            enableBackup: true,
            enableProbability: true,
            enableSound: true,
            soundType: 'windup' // 默认为发条音效
        };
        
        settings = {...defaultSettings, ...settings};
        
        applySettingsToUI();
        saveSettings();
    }
    
    // 应用设置到UI
    function applySettingsToUI() {
        const rollModeRadio = document.querySelector(`input[name="rollMode"][value="${settings.rollMode}"]`);
        if (rollModeRadio) rollModeRadio.checked = true;
        
        document.getElementById('preventRepeat').checked = settings.preventRepeat;
        document.getElementById('excludeAbsent').checked = settings.excludeAbsent;
        document.getElementById('excludeManual').checked = settings.excludeManual !== false;
        document.getElementById('enableAnimation').checked = settings.enableAnimation;
        document.getElementById('animationSpeed').value = settings.animationSpeed;
        document.getElementById('highlightEffect').value = settings.highlightEffect;
        document.getElementById('themeSelect').value = settings.theme;
        document.getElementById('enableProbability').checked = settings.enableProbability !== false;
        document.getElementById('enableSound').checked = settings.enableSound !== false;
        document.getElementById('soundType').value = settings.soundType || 'windup';
    }
    
    // 保存点名设置
    function saveRollSettings() {
        const rollMode = document.querySelector('input[name="rollMode"]:checked').value;
        settings.rollMode = rollMode;
        settings.preventRepeat = document.getElementById('preventRepeat').checked;
        settings.excludeAbsent = document.getElementById('excludeAbsent').checked;
        settings.excludeManual = document.getElementById('excludeManual').checked;
        
        saveSettings();
        alert('点名设置已保存！');
    }
    
    // 保存动画设置
    function saveAnimationSettings() {
        settings.enableAnimation = document.getElementById('enableAnimation').checked;
        settings.animationSpeed = document.getElementById('animationSpeed').value;
        settings.highlightEffect = document.getElementById('highlightEffect').value;
        
        saveSettings();
        alert('动画设置已保存！');
    }
    
    // 保存通用设置
    function saveGeneralSettings() {
        settings.theme = document.getElementById('themeSelect').value;
        settings.enableSound = document.getElementById('enableSound').checked;
        settings.soundType = document.getElementById('soundType').value;
        
        saveSettings();
        alert('通用设置已保存！');
        updateSoundEffectStatus();
    }
    
    // 清除所有数据
    function clearAllData() {
        if (confirm('确定要清除所有数据吗？这将删除所有学生信息、设置和出勤记录，此操作不可撤销！')) {
            localStorage.clear();
            location.reload();
        }
    }
    
    // 更改主题
    function changeTheme() {
        const theme = document.getElementById('themeSelect').value;
        document.body.className = `theme-${theme}`;
        settings.theme = theme;
        saveSettings();
    }
    
    // 根据概率随机选择学生
    function selectRandomStudentsByProbability(count) {
        const selected = [];
        const availableStudents = [];
        
        for (let i = 0; i < students.length; i++) {
            if (settings.preventRepeat && lastSelectedStudent === i) {
                continue;
            }
            
            if (settings.excludeAbsent && 
                (students[i].attendance === 'leave' || students[i].attendance === 'absent')) {
                continue;
            }
            
            if (settings.excludeManual && students[i].excluded) {
                continue;
            }
            
            availableStudents.push({
                index: i,
                probability: students[i].probability
            });
        }
        
        if (availableStudents.length < count) {
            availableStudents.length = 0;
            for (let i = 0; i < students.length; i++) {
                if (settings.excludeAbsent && 
                    (students[i].attendance === 'leave' || students[i].attendance === 'absent')) {
                    continue;
                }
                
                if (settings.excludeManual && students[i].excluded) {
                    continue;
                }
                
                availableStudents.push({
                    index: i,
                    probability: students[i].probability
                });
            }
        }
        
        if (availableStudents.length < count) {
            availableStudents.length = 0;
            for (let i = 0; i < students.length; i++) {
                if (settings.excludeAbsent && 
                    (students[i].attendance === 'leave' || students[i].attendance === 'absent')) {
                    continue;
                }
                
                availableStudents.push({
                    index: i,
                    probability: students[i].probability
                });
            }
        }
        
        if (!settings.enableProbability) {
            for (let i = 0; i < count; i++) {
                if (availableStudents.length === 0) break;
                
                const randomIndex = Math.floor(Math.random() * availableStudents.length);
                const selectedIndex = availableStudents[randomIndex].index;
                
                selected.push(selectedIndex);
                availableStudents.splice(randomIndex, 1);
            }
            
            if (selected.length === 1) {
                lastSelectedStudent = selected[0];
            }
            
            return selected;
        }
        
        for (let i = 0; i < count; i++) {
            if (availableStudents.length === 0) break;
            
            let totalProbability = 0;
            for (const student of availableStudents) {
                totalProbability += student.probability;
            }
            
            const random = Math.random() * totalProbability;
            
            let cumulativeProbability = 0;
            let selectedIndex = -1;
            let selectedStudentIndexInArray = -1;
            
            for (let j = 0; j < availableStudents.length; j++) {
                cumulativeProbability += availableStudents[j].probability;
                if (random <= cumulativeProbability) {
                    selectedIndex = availableStudents[j].index;
                    selectedStudentIndexInArray = j;
                    break;
                }
            }
            
            if (selectedIndex === -1) {
                selectedIndex = availableStudents[0].index;
                selectedStudentIndexInArray = 0;
            }
            
            selected.push(selectedIndex);
            availableStudents.splice(selectedStudentIndexInArray, 1);
        }
        
        if (selected.length === 1) {
            lastSelectedStudent = selected[0];
        }
        
        return selected;
    }
    
    // 模拟抽取动画
    function showDrawingAnimation(count) {
        resultDisplay.innerHTML = '';
        resultTitle.innerHTML = `<i class="fas fa-spinner spinning"></i> 正在随机抽取中...`;
        statusReadyElement.textContent = "抽取中...";
        
        if (!settings.enableAnimation) {
            return;
        }
        
        // 使用文档片段优化
        const fragment = document.createDocumentFragment();
        
        for (let i = 0; i < count; i++) {
            const card = document.createElement('div');
            card.className = 'student-card drawing-animation';
            card.style.animationDelay = `${i * 0.1}s`;
            card.style.animationDuration = settings.animationSpeed === 'slow' ? '0.8s' : 
                                          settings.animationSpeed === 'fast' ? '0.3s' : '0.5s';
            
            card.innerHTML = `
                <div class="avatar-container">
                    <div class="default-avatar">
                        <i class="fas fa-random"></i>
                    </div>
                </div>
                <div class="student-info">
                    <div class="student-name">随机抽取中...</div>
                    <div class="student-number">${i + 1}号</div>
                </div>
            `;
            
            fragment.appendChild(card);
        }
        
        resultDisplay.appendChild(fragment);
    }
    
    // 更新抽取信息
    function updateDrawInfo() {
        drawnCountElement.textContent = drawnCount;
        localStorage.setItem('classRollerDrawnCount', drawnCount);
        
        // 更新模式状态
        const rollMode = settings.rollMode || 'random';
        if (rollMode === 'random') {
            modeStatusElement.textContent = "随机点名";
        } else if (rollMode === 'sequential') {
            modeStatusElement.textContent = "顺序点名";
        } else if (rollMode === 'group') {
            modeStatusElement.textContent = "分组点名";
        }
    }
    
    // 开始抽取 - 已修复音效播放时机
    function startDrawing() {
        if (isDrawing) return;
        
        isDrawing = true;
        
        showDrawingAnimation(selectedCount);
        
        startBtn.innerHTML = `<i class="fas fa-spinner spinning"></i> 抽取中...`;
        startBtn.disabled = true;
        
        // 重要修复：在开始抽取时播放音效，而不是结束时
        // 播放发条音效（开始抽取时播放）
        playSoundEffect();
        
        // 使用requestAnimationFrame优化动画
        requestAnimationFrame(() => {
            setTimeout(() => {
                const selectedIndices = selectRandomStudentsByProbability(selectedCount);
                
                displayResults(selectedIndices);
                
                startBtn.innerHTML = `<i class="fas fa-play-circle"></i> 开始点名`;
                startBtn.disabled = false;
                isDrawing = false;
                
                // 更新抽取次数
                drawnCount++;
                updateDrawInfo();
                
                // 重要修复：不再在抽取结束时播放音效，因为已经在开始时播放了
                // 检查是否抽到特殊学生
                checkSpecialEffect(selectedIndices);
                
                // 恢复状态显示
                setTimeout(() => {
                    statusReadyElement.textContent = "准备就绪";
                }, 2000);
            }, 3500); // 3.5秒的抽取动画
        });
    }
    
    // 显示抽取结果
    function displayResults(selectedIndices) {
        resultDisplay.innerHTML = '';
        
        // 使用文档片段优化
        const fragment = document.createDocumentFragment();
        
        selectedIndices.forEach((index, i) => {
            const card = document.createElement('div');
            card.className = 'student-card fade-in';
            card.style.animationDelay = `${i * 0.2}s`;
            
            const badge = document.createElement('div');
            badge.className = 'result-badge';
            badge.textContent = i + 1;
            
            const avatarContainer = document.createElement('div');
            avatarContainer.className = 'avatar-container';
            
            const student = students[index];
            const avatarElement = createAvatarImg(student.studentId, student.name);
            
            if (avatarElement.tagName === 'IMG') {
                avatarContainer.appendChild(avatarElement);
            } else {
                avatarContainer.appendChild(avatarElement);
            }
            
            card.appendChild(avatarContainer);
            card.appendChild(badge);
            
            const studentInfo = document.createElement('div');
            studentInfo.className = 'student-info';
            studentInfo.innerHTML = `
                <div class="student-name">${student.name}</div>
                <div class="student-number">${student.studentId}号</div>
            `;
            
            card.appendChild(studentInfo);
            fragment.appendChild(card);
            
            // 延迟添加选中效果
            setTimeout(() => {
                requestAnimationFrame(() => {
                    card.classList.add('selected');
                    
                    if (selectedIndices.length === 1) {
                        setTimeout(() => {
                            requestAnimationFrame(() => {
                                card.classList.add('highlight');
                            });
                        }, 1000);
                    }
                });
            }, i * 200 + 800);
        });
        
        resultDisplay.appendChild(fragment);
        
        if (selectedIndices.length === 1) {
            resultTitle.innerHTML = `<i class="fas fa-user-check"></i> 点到：${students[selectedIndices[0]].name}`;
        } else {
            const names = selectedIndices.map(idx => students[idx].name).join('、');
            resultTitle.innerHTML = `<i class="fas fa-users"></i> 点到：${names}`;
        }
    }
    
    // 切换菜单部分
    function toggleMenuSection(header) {
        const content = header.nextElementSibling;
        const isActive = content.classList.contains('active');
        
        document.querySelectorAll('.menu-section-content').forEach(section => {
            section.classList.remove('active');
        });
        
        document.querySelectorAll('.menu-section-header').forEach(h => {
            h.classList.remove('active');
        });
        
        if (!isActive) {
            content.classList.add('active');
            header.classList.add('active');
        }
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
